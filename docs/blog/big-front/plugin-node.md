---
layout: doc
---

# Node å­¦ä¹ ç¬”è®°

<br />

> [Node.js å®Œå…¨æŒ‡å—ï¼ˆç›´æ’­å›æ”¾ï¼‰æç«‹è¶… - bilibili ğŸ“º](https://www.bilibili.com/video/BV1qN4y1A7jM)
> 
> æºç ç¬”è®°é“¾æ¥ï¼šhttps://pan.baidu.com/s/1jE10ooFCzpV6ddSqHyYJow?pwd=9658
> 
> æå–ç ï¼š9658

## ç®€ä»‹

- è¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„ JS
- ç”¨æ¥ç¼–å†™æœåŠ¡å™¨
- ç‰¹ç‚¹
  - å•çº¿ç¨‹ã€å¼‚æ­¥ã€éé˜»å¡
  - ç»Ÿä¸€ API

::: tip
ç‰ˆæœ¬ç®¡ç†å™¨ä¸»è¦æœ‰ nvm å’Œ nvsï¼Œé€šè¿‡ç®¡ç†å™¨å¯è‡ªç”±åˆ‡æ¢ä¸åŒçš„ node.js ç‰ˆæœ¬ï¼Œä»¥ä¾¿å¼€å‘ä¸åŒçš„é¡¹ç›®ã€‚

- [nvm](https://github.com/nvm-sh/nvm): ä¸€ä¸ª Node.js ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œä½¿ç”¨ bash å®ç°ï¼Œå‡ ä¹æ˜¯ä¸šå†…æœ€æœ‰åã€‚
- [nvs](https://github.com/jasongin/nvs): åŒæ ·æ˜¯ä¸€ä¸ªçš„ Node.js ç‰ˆæœ¬åˆ‡æ¢å™¨ï¼Œä½¿ç”¨ JavaScript å®ç°ï¼Œè·¨å¹³å°ã€‚

:::

JavaScript å’Œ Node.js çš„åŒºåˆ«ï¼š

|      åˆ†ç±»      | JavScript | Node.js |
| :------------: | :-------: | :-----: |
|   ECMAScript   |    âœ…     |   âœ…    |
| DOM - å®¿ä¸»å¯¹è±¡ |    âœ…     |   âŒ    |
| BOM - å®¿ä¸»å¯¹è±¡ |    âœ…     |   âŒ    |

> Node.js è™½ç„¶ä¹Ÿå±äº jsï¼Œä½†æ˜¯å®ƒå’Œæµè§ˆå™¨ä¸­ js è¿˜æ˜¯æœ‰æ‰€åŒºåˆ«çš„ã€‚å¯¹äº ECMAScript æ ‡å‡†æ¥è¯´ï¼Œå®ƒä»¬æ˜¯ä¸€è‡´çš„æ‰€ä»¥åƒæ˜¯åŸå§‹å€¼ã€æµç¨‹æ§åˆ¶è¯­å¥ã€è¿ç®—ç¬¦ã€å‡½æ•°ã€å¯¹è±¡ã€æ•°ç»„ã€å†…å»ºå¯¹è±¡è¿™äº›ä¸œè¥¿æ— è®ºæ˜¯æµè§ˆå™¨ç¯å¢ƒè¿˜æ˜¯ node ä¸­éƒ½æ˜¯ä¸€æ ·çš„ã€‚å¯¹äºå®¿ä¸»å¯¹è±¡æ¥è¯´æµè§ˆå™¨å’Œ node æ˜¯æˆªç„¶ä¸åŒçš„ï¼Œåƒæ˜¯ DOMã€BOM è¿™äº›å¯¹è±¡åœ¨ node ä¸­é€šé€šæ˜¯ä¸å­˜åœ¨çš„ï¼Œä½†æ˜¯ä¸€äº›ä¸œè¥¿åœ¨ Node ä¸­ä¾ç„¶å¾—åˆ°äº†ä¿ç•™ï¼Œæ¯”å¦‚ console å¯¹è±¡ã€æ¯”å¦‚å®šæ—¶å™¨ä¹‹ç±»ã€‚

## å¼‚æ­¥ç¼–ç¨‹ & Promise

::: tip
è¿›ç¨‹å’Œçº¿ç¨‹

- è¿›ç¨‹ï¼šç¨‹åºçš„è¿è¡Œç¯å¢ƒ
- çº¿ç¨‹ï¼šå®é™…è¿›è¡Œè¿ç®—çš„ä¸œè¥¿

:::

### åŒæ­¥å¼‚æ­¥

1. åŒæ­¥ï¼š

- é€šå¸¸æƒ…å†µä¸‹ä»£ç éƒ½æ˜¯`è‡ªä¸Šå‘ä¸‹ä¸€è¡Œä¸€è¡Œ`åœ°æ‰§è¡Œï¼Œå‰é¢çš„ä»£ç ä¸æ‰§è¡Œåé¢çš„ä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œ
- åŒæ­¥çš„ä»£ç æ‰§è¡Œä¼šå‡ºç°`é˜»å¡`çš„æƒ…å†µï¼Œä¸€è¡Œä»£ç æ‰§è¡Œæ…¢ä¼šå½±å“æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œ

2. è§£å†³åŒæ­¥é—®é¢˜ï¼š

- Java Python
  - é€šè¿‡å¤šçº¿ç¨‹æ¥è§£å†³
- Node.js
  - JS æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œé€šè¿‡`å¼‚æ­¥ç¼–ç¨‹`æ¥è§£å†³

3. å¼‚æ­¥ï¼š

- ä¸€æ®µä»£ç çš„æ‰§è¡Œä¸ä¼šå½±å“å…¶ä»–ç¨‹åºçš„æ‰§è¡Œ
- å¼‚æ­¥çš„é—®é¢˜ï¼š
  - `å¼‚æ­¥çš„ä»£ç æ— æ³•é€šè¿‡ return æ¥è®¾ç½®è¿”å›å€¼`

4. ç‰¹ç‚¹ï¼š

- 1. ä¸ä¼šé˜»å¡å…¶å®ƒä»£ç çš„æ‰§è¡Œ
- 2. éœ€è¦é€šè¿‡å›è°ƒå‡½æ•°æ¥è¿”å›ç»“æœ

5. å¼‚æ­¥å®ç°æ–¹å¼ï¼š

- å›è°ƒå‡½æ•°ï¼šè¿‡åº¦ä½¿ç”¨ä¼šå‡ºç°`å›è°ƒåœ°ç‹±`ï¼Œä»£ç çš„å¯è¯»æ€§å·®ã€å¯è°ƒè¯•æ€§å·®
- Promiseï¼š`æ˜¯å­˜å‚¨æ•°æ®çš„å¯¹è±¡`

```javascript
// å›è°ƒåœ°ç‹±æ¡ˆä¾‹
const sum = (a, b, cb) => {
  setTimeout(() => {
    cb(a + b);
  }, 1000);
};

sum(1, 2, (result) => {
  sum(result, 3, (result) => {
    sum(result, 4, (result) => {
      sum(result, 5, (result) => {
        console.log(result);
      });
    });
  });
});
```

### Promise

Promise å°±æ˜¯ä¸€ä¸ªç”¨æ¥`å­˜å‚¨æ•°æ®å¯¹è±¡`ï¼Œä½†æ˜¯ç”±äº Promise å­˜å–çš„æ–¹å¼çš„ç‰¹æ®Šï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†å¼‚æ­¥è°ƒç”¨çš„ç»“æœå­˜å‚¨åˆ° Promise ä¸­ã€‚

å¯¹ Promise è¿›è¡Œé“¾å¼è°ƒç”¨æ—¶ï¼š

- åè¾¹çš„æ–¹æ³•ï¼ˆthen å’Œ catchï¼‰è¯»å–çš„ä¸Šä¸€æ­¥çš„æ‰§è¡Œç»“æœï¼Œå¦‚æœä¸Šä¸€æ­¥çš„æ‰§è¡Œç»“æœä¸æ˜¯å½“å‰æƒ³è¦çš„ç»“æœï¼Œåˆ™è·³è¿‡å½“å‰çš„æ–¹æ³•ï¼›
- å½“ Promise å‡ºç°å¼‚å¸¸æ—¶ï¼Œè€Œæ•´ä¸ªè°ƒç”¨é“¾ä¸­æ²¡æœ‰å‡ºç° catchï¼Œåˆ™å¼‚å¸¸ä¼šå‘å¤–æŠ›å‡ºã€‚

`Promise è§£å†³å¼‚æ­¥ç¼–ç¨‹ä¸­å›è°ƒåœ°ç‹±é—®é¢˜`

#### æ¡ˆä¾‹

åˆ›å»º Promise å®ä¾‹ï¼ŒåŠè·å– Promise ä¸­çš„æ•°æ®

```javascript
// åˆ›å»º Promise æ—¶ï¼Œæ„é€ å‡½æ•°ä¸­éœ€è¦ä¸€ä¸ªå‡½æ•°[æ‰§è¡Œå™¨]ä½œä¸ºå‚æ•°
// Promise æ„é€ å‡½æ•°çš„å›è°ƒå‡½æ•°ï¼Œå®ƒä¼šåœ¨åˆ›å»º Promise æ—¶è°ƒç”¨ï¼Œè°ƒç”¨æ—¶ä¼šæœ‰ä¸¤ä¸ªå‚æ•°ä¼ é€’è¿›å»
const promise = new Promise((resolve, reject) => {
  // resolve å’Œ reject æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥åˆ†åˆ«å‘ Promise ä¸­å­˜å‚¨æ•°æ®
  // resolve è¡¨ç¤ºæ‰§è¡Œæ­£å¸¸æ—¶å­˜å‚¨æ•°æ®ï¼Œreject è¡¨ç¤ºæ‰§è¡Œå¼‚å¸¸æ—¶å­˜å‚¨æ•°æ®
  // é€šè¿‡å‡½æ•°æ¥å‘ Promise ä¸­æ·»åŠ æ•°æ®ï¼Œå¥½å¤„å°±æ˜¯å¯ä»¥æ·»åŠ å¼‚æ­¥è°ƒç”¨çš„æ•°æ®
  resolve("æˆåŠŸ"); // reject("å¤±è´¥")
});

// è·å– Promise ä¸­çš„æ•°æ®
//  - å¯ä»¥é€šè¿‡ Promise çš„å®ä¾‹æ–¹æ³• then æ¥è¯»å– Promise çš„æ•°æ®
//  - then éœ€è¦ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå›è°ƒå‡½æ•°ç”¨æ¥è·å– Promise ä¸­çš„æ•°æ®
//    - é€šè¿‡ resolve å­˜å‚¨çš„æ•°æ®ï¼Œä¼šè°ƒç”¨ç¬¬ä¸€ä¸ªå‡½æ•°è¿”å›ï¼Œ
//      å¯ä»¥åœ¨ç¬¬ä¸€ä¸ªå‡½æ•°ä¸­ç¼–å†™å¤„ç†æ•°æ®çš„ä»£ç 
//    - é€šè¿‡ reject å­˜å‚¨çš„æ•°æ®æˆ–å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šè°ƒç”¨ç¬¬äºŒä¸ªå‡½æ•°è¿”å›ï¼Œ
//      å¯ä»¥åœ¨ç¬¬äºŒä¸ªå‡½æ•°ä¸­ç¼–å†™å¤„ç†å¼‚å¸¸çš„ä»£ç 
promise.then(
  (result) => {
    console.log("resolve çš„æ•°æ®" + result);
  },
  (reason) => {
    console.log("reject çš„æ•°æ®" + reason);
  }
);

// or
promise
  .then((result) => {
    console.log("resolve çš„æ•°æ®" + result);
  })
  .catch((reason) => {
    console.log("reject çš„æ•°æ®" + reason);
  })
  .finally(() => {
    console.log("æ— è®º resolve è¿˜æ˜¯ reject éƒ½ä¼šæ‰§è¡Œ");
  });
```

å›è°ƒåœ°ç‹±çš„è§£å†³

```javascript
const sum = (a, b) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(a + b);
    }, 1000);
  });
};

sum(10, 20)
  .then((result) => {
    return sum(result, 30);
  })
  .then((result) => {
    return sum(result, 40);
  })
  .then((result) => {
    return sum(result, 50);
  })
  .then((result) => {
    console.log(result);
  });
```

#### å±æ€§

åœ¨ Promise ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªéšè—çš„å±æ€§

- [[PromiseResult]]ï¼Œç”¨æ¥å­˜å‚¨æ•°æ®
- [[PromiseState]]ï¼Œè®°å½• Promise çŠ¶æ€ï¼Œåªèƒ½ä¿®æ”¹ä¸€æ¬¡
  - `pending è¿›è¡Œä¸­`
  - `fulfilled å®Œæˆ`ï¼Œé€šè¿‡ resolve å­˜å‚¨æ•°æ®æ—¶
  - `rejected æ‹’ç»ã€å¼‚å¸¸`ï¼Œå½“å‡ºç°å¼‚å¸¸æˆ–é€šè¿‡ reject å­˜å‚¨æ•°æ®æ—¶

::: tip
åœ¨ Promise ä¸­è°ƒç”¨ thenã€catchã€finally æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ª`æ–°çš„ Promise`ï¼Œåœ¨ thenã€catch ä¸­ `æ–°çš„ Promise` ä¼šå­˜å‚¨`å›è°ƒå‡½æ•°çš„è¿”å›å€¼`ï¼Œfinally ä¸­ `æ–°çš„ Promise`å­˜å‚¨ä¸Šçš„å€¼`å§‹ç»ˆä¸º undefined`.

```javascript
let promise = new Promise((resolve, reject) => {
  resolve("åˆ›å»º Promise å®ä¾‹");
});

// promise é“¾å¼è°ƒç”¨
promise
  .then((result) => {
    console.log(result); // -> åˆ›å»º Promise å®ä¾‹ // [!code ++]
    return "promise å®ä¾‹è°ƒç”¨ then æ–¹æ³•";
  })
  .then((result) => {
    console.log(result); // -> promise å®ä¾‹è°ƒç”¨ then æ–¹æ³• // [!code ++]
  });
```

:::

#### é™æ€æ–¹æ³•

- Promise.resolve()
  - åˆ›å»ºä¸€ä¸ªç«‹å³å®Œæˆçš„ Promise
- Promise.reject()
  - åˆ›å»ºä¸€ä¸ªç«‹å³æ‹’ç»çš„ Promise
- Promise.all([iterable])
  - åŒæ—¶è¿”å›å¤šä¸ª Promise çš„æ‰§è¡Œç»“æœï¼Œå¦‚æœ‰ä¸€ä¸ª rejected å°±è¿”å›é”™è¯¯
- Promise.allSettled([iterable])
  - åŒæ—¶è¿”å›å¤šä¸ª Promise çš„æ‰§è¡Œç»“æœï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ fulfilled and rejected
- Promise.race([iterable])
  - è¿”å›æ‰§è¡Œæœ€å¿«çš„ Promiseï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ fulfilled and rejected
- Promise.any([iterable])
  - è¿”å›æ‰§è¡Œæœ€å¿«å®Œæˆ fulfilled çš„ Promiseï¼Œ

## å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

åœ¨ js ä¸­ï¼Œå®ƒæ˜¯å•çº¿ç¨‹çš„ï¼Œå®ƒçš„è¿è¡Œæ—¶åŸºäº`äº‹ä»¶å¾ªç¯æœºåˆ¶(event loop)`

å‰ç½®çŸ¥è¯†ï¼š

- æ ˆï¼Œä¸€ç§æ•°æ®ç»“æ„ï¼Œå…ˆè¿›åå‡º
- é˜Ÿåˆ—ï¼Œä¸€ç§æ•°æ®ç»“æ„ï¼Œå…ˆè¿›å…ˆå‡º

äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼š

- è°ƒç”¨æ ˆï¼Œå­˜æ”¾çš„æ˜¯éœ€è¦æ‰§è¡Œçš„ä»£ç 
- ä»»åŠ¡é˜Ÿåˆ—ï¼Œå­˜æ”¾çš„æ˜¯å°†è¦æ‰§è¡Œçš„ä»£ç 
  - å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ½ä¼šåˆ°æ­¤è¿›è¡Œæ’é˜Ÿ
  - å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ŒPromise çš„å›è°ƒå‡½æ•°

äº‹ä»¶å¾ªç¯æµç¨‹ï¼š

1. æ‰§è¡Œè°ƒç”¨æ ˆä¸­çš„ä»£ç 
2. æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç 
3. æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç 

::: info å°è¯•ç‰›åˆ€

```javascript
console.log(1);
setTimeout(() => console.log(2));
Promise.resolve().then(() => console.log(3));
Promise.resolve().then(() => setTimeout(() => console.log(4)));
Promise.resolve().then(() => console.log(5));
setTimeout(() => console.log(6));
console.log(7);
```

:::

::: details ç­”æ¡ˆ

```javascript
// 1 7 3 5 2 6 4
```

:::

::: tip
queueMicrotask() å¯ç”¨æ¥å‘å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡
:::

## æ‰‹å†™ Promise

```javascript
const PromiseState = {
  PENDING: "0",
  FULFILLED: "1",
  REJECTED: "2",
};

class MyPromise {
  #result;
  #state = PromiseState.PENDING;
  #callbacksFulfilled = [];
  #callbacksRejected = [];

  constructor(executor) {
    executor(this.#resolve.bind(this), this.#reject.bind(this));
  }

  #resolve(result) {
    if (this.#state !== PromiseState.PENDING) return;

    this.#result = result;
    this.#state = PromiseState.FULFILLED;

    queueMicrotask(() => {
      this.#callbacksFulfilled.forEach((cb) => {
        cb();
      });
    });
  }

  #reject(reason) {
    if (this.#state !== PromiseState.PENDING) return;

    this.#result = reason;
    this.#state = PromiseState.REJECTED;

    queueMicrotask(() => {
      this.#callbacksRejected.forEach((cb) => {
        cb();
      });
    });
  }

  then(onFulfilled, onRejected) {
    return new MyPromise((resolve, reject) => {
      if (this.#state === PromiseState.PENDING) {
        this.#callbacksFulfilled.push(() => {
          resolve(onFulfilled(this.#result));
        });
        this.#callbacksRejected.push(() => {
          reject(onRejected(this.#result));
        });
      } else if (this.#state === PromiseState.FULFILLED) {
        queueMicrotask(() => resolve(onFulfilled(this.#result)));
      } else if (this.#state === PromiseState.REJECTED) {
        queueMicrotask(() => reject(onRejected(this.#result)));
      }
    });
  }
}

const mp = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve("å“ˆå“ˆ");
  }, 1000);
});

mp.then((result) => {
  console.log("ç¬¬1æ¬¡è¯»å–æ•°æ®", result);
}).then((result) => {
  console.log("ç¬¬2æ¬¡è¯»å–æ•°æ®", result);
});
```

::: details ç»“æœ

```javascript
// ç¬¬1æ¬¡è¯»å–æ•°æ® å“ˆå“ˆ
// ç¬¬2æ¬¡è¯»å–æ•°æ® undefined
```

:::

## async & await

é€šè¿‡ async å¯ä»¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå…¶ä¸­å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼ä¼šè‡ªåŠ¨å°è£…åˆ°ä¸€ä¸ª Promise ä¸­è¿”å›ï¼›

åœ¨ async å£°æ˜çš„å¼‚æ­¥å‡½æ•°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ await å…³é”®å­—æ¥è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼›

```javascript
async function fun1() {
  return 10;
}

// ç­‰ä»·äº
function fun2() {
  return Promise.resolve(10);
}
```

```javascript
function sum(a, b) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(a + b);
    });
  });
}

async function fun3() {
  try {
    let result = 0;
    result = await sum(123, 456);
    result = await sum(result, 789);
    console.log(result);
  } catch (err) {} // å¼‚å¸¸æ•è·
}
fun3(); // è¾“å‡º: 1368

// ç­‰ä»·äº
function fun4() {
  sum(123, 456)
    .then((res) => {
      return sum(res, 789);
    })
    .then((res) => {
      console.log(res);
    })
    .catch((err) => {}); // å¼‚å¸¸æ•è·
}
fun4();
```

:::tip
Promise çš„å‡ºç°è§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä½†æ˜¯è¿‡äº Promise é“¾å¼è°ƒç”¨æ—¶ï¼Œä»£ç çš„å¯è¯»æ€§å˜å·®ï¼Œæ‰€ä»¥å‡ºç°äº† async å’Œ await æ¥å®ç°`åŒæ­¥å†™æ³•`ã€‚
:::

æ‰§è¡Œé¡ºåº

```javascript
/* 
  å¦‚æœ async å£°æ˜çš„å‡½æ•°ä¸­æ²¡æœ‰å†™ awaitï¼Œé‚£ä¹ˆä¼šä¾æ¬¡æ‰§è¡Œ
*/
async function fun5() {
  console.log(1);
  console.log(2);
  console.log(3);
}
fun5(); // è¾“å‡º: 1 2 3

// ç­‰ä»·äº
function fun6() {
  return new Promise((resolve) => {
    console.log(1);
    console.log(2);
    console.log(3);
    resolve();
  });
}
fun6();
```

```javascript
/* 
  å¦‚æœä½¿ç”¨ await å…³é”®å­—ï¼Œåˆ™åé¢çš„ä»£ç ï¼Œä¼šåœ¨å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œæ”¾ç½®å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ
*/
async function fun7() {
  console.log(1);
  await console.log(2);
  await console.log(3);
  console.log(4);
}
fun7();
console.log(5); // ä¾æ­¤è¾“å‡º: 1 2 5 3 4

// ç­‰ä»·äº
function fun8() {
  new Promise((resolve) => {
    console.log(1);
    console.log(2);
    resolve();
  })
    .then(() => {
      console.log(3);
    })
    .then(() => {
      console.log(4);
    });
}
fun8();
console.log(5);
```

:::tip ç»†èŠ‚

1. å½“é€šè¿‡ await å»è°ƒç”¨å¼‚æ­¥å‡½æ•°æ—¶ï¼Œå®ƒä¼šæš‚åœä»£ç çš„æ‰§è¡Œï¼Œå¹¶ç­‰å¾…å¼‚æ­¥å‡½æ•°çš„è¿”å›ç»“æœï¼ŒçŸ¥é“å¼‚æ­¥ä»£ç æ‰§è¡Œæœ‰ç»“æœæ—¶ï¼Œæ‰ä¼šå°†ç»“æœè¿”å›ï¼›
2. await å¿…é¡»å†™åœ¨ async å‡½æ•°ä¸­ï¼Œæˆ– ES Modules çš„é¡¶çº§ä½œç”¨åŸŸä¸­ï¼›
3. await åªä¼šé˜»å¡å¼‚æ­¥å‡½æ•°çš„å†…éƒ¨ä»£ç ï¼Œä¸ä¼šå½±å“å¤–éƒ¨ä»£ç çš„æ‰§è¡Œï¼›
4. é€šè¿‡ä½¿ç”¨ await è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼Œéœ€è¦ä½¿ç”¨ try-catch æ¥å¤„ç†å¼‚å¸¸ï¼›
5. å¦‚æœ async å£°æ˜çš„å‡½æ•°ä¸­æ²¡æœ‰å†™ awaitï¼Œé‚£ä¹ˆä¼šä¾æ¬¡æ‰§è¡Œï¼›
6. å¦‚æœä½¿ç”¨ await å…³é”®å­—ï¼Œåˆ™åé¢çš„ä»£ç ï¼Œä¼šåœ¨å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œæ”¾ç½®å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚

:::

## æ¨¡å—åŒ–

åœ¨æ—©æœŸçš„ç½‘é¡µä¸­ï¼Œæ˜¯æ²¡æœ‰ä¸€ä¸ªå®è´¨çš„æ¨¡å—åŒ–è§„èŒƒçš„ï¼Œæ­¤å‰æƒ³è¦å®ç°æ¨¡å—çš„æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡æœ€åŸå§‹çš„æ–¹å¼ script æ ‡ç­¾æ¥å¼•å…¥å¤šä¸ª js æ–‡ä»¶ï¼ˆä¾‹å¦‚ jquery å’Œ bootstrapUIï¼‰ã€‚

é€šè¿‡ script æ ‡ç­¾å®ç°çš„æ¨¡å—åŒ–ï¼Œä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. æ— æ³•é€‰æ‹©è¦å¼•å…¥çš„æ¨¡å—å†…å®¹ï¼ˆæ— æ³•æŒ‰éœ€å¼•å…¥ï¼‰
2. åœ¨å¤æ‚çš„æ¨¡å—åœºæ™¯ä¸‹éå¸¸å®¹æ˜“å‡ºé”™ï¼ˆå¦‚æœæ¨¡å—ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆæ¨¡å—çš„è½½å…¥é¡ºåºæ˜¯éšå½¢è¦æ±‚çš„ï¼‰

::: info

jQuery æ˜¯é€šè¿‡ script æ ‡ç­¾å¼•å…¥çš„å½¢å¼æ¥å®Œæˆæ¨¡å—åŒ–çš„ï¼Œå¼•å…¥åå®é™…æ•ˆæœæ˜¯å‘å…¨å±€ä½œç”¨åŸŸä¸­æ·»åŠ äº†ä¸€ä¸ªå˜é‡$ï¼ˆæˆ– jQueryï¼‰è¿™æ ·å¾ˆå®¹æ˜“å‡ºç°æ¨¡å—é—´äº’ç›¸è¦†ç›–çš„æƒ…å†µã€‚å¹¶ä¸”å½“æˆ‘ä»¬ä½¿ç”¨äº†è¾ƒå¤šçš„æ¨¡å—æ—¶ï¼Œæœ‰ä¸€äº›æ¨¡å—æ˜¯ç›¸äº’ä¾èµ–çš„ï¼Œå¿…é¡»å…ˆå¼•å…¥æŸä¸ªç»„ä»¶å†å¼•å…¥æŸä¸ªç»„ä»¶ï¼Œæ¨¡å—æ‰èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚æ¯”å¦‚ jQuery å’Œ jQueryUIï¼Œå°±å¿…é¡»å…ˆå¼•å…¥ jQueryï¼Œå¦‚æœå¼•å…¥é¡ºåºå‡ºé”™å°†å¯¼è‡´ jQueryUI æ— æ³•ä½¿ç”¨ã€‚è¿™è¿˜ä»…ä»…æ˜¯ä¸¤ä¸ªç»„ä»¶ï¼Œè€Œå®é™…å¼€å‘ä¸­çš„ä¾èµ–å…³ç³»å¾€å¾€æ›´åŠ å¤æ‚ï¼Œåƒæ˜¯ a ä¾èµ– bï¼Œb ä¾èµ– cï¼Œc ä¾èµ– d è¿™ç§å…³ç³»ï¼Œå¿…é¡»æŒ‰ç…§ dã€cã€bã€a çš„é¡ºåºè¿›è¡Œå¼•å…¥ï¼Œæœ‰ä¸€ä¸ªé¡ºåºé”™è¯¯å°±ä¼šå¯¼è‡´å…¶ä»–çš„ä¸€èµ·å¤±æ•ˆã€‚æ‰€ä»¥é€šè¿‡ script æ ‡ç­¾å®ç°çš„æ¨¡å—åŒ–æ˜¯éå¸¸çš„ä¸é è°±çš„ã€‚

[è¶…å“¥ç¬”è®°](https://lilichao.com/?p=6449)

:::

### CommonJS

CommonJS æ˜¯ Node.js æœ€æ—©é‡‡ç”¨çš„æ¨¡å—åŒ–è§„èŒƒï¼ˆ2009 å¹´ï¼‰ã€é»˜è®¤ã€‘ã€‚

**æ–‡ä»¶ä½œä¸ºæ¨¡å—**æ—¶ï¼Œå¼•å…¥æ¨¡å—ï¼š

- ä½¿ç”¨ require("æ¨¡å—çš„è·¯å¾„")å‡½æ•°æ¥å¼•å…¥æ¨¡å—
- å¼•å…¥`è‡ªå®šä¹‰æ¨¡å—`æ—¶
  - æ¨¡å—åè¦ä»¥ ./ æˆ– ../ å¼€å¤´
  - æ‰©å±•åå¯ä»¥çœç•¥
    - åœ¨ CommonJS ä¸­ï¼Œå¦‚æœçœç•¥çš„ js æ–‡ä»¶çš„æ‰©å±•å nodeï¼Œä¼šè‡ªåŠ¨ä¸ºæ–‡ä»¶è¡¥å…¨æ‰©å±•å ./m1.js å¦‚æœæ²¡æœ‰ js å®ƒä¼šå¯»æ‰¾ ./m1.json
    - æœç´¢ä¼˜å…ˆçº§ï¼š.js --> .json --> .nodeï¼ˆç‰¹æ®Šï¼‰
- å¼•å…¥`æ ¸å¿ƒæ¨¡å—`æ—¶
  - ç›´æ¥å†™æ ¸å¿ƒæ¨¡å—çš„åå­—å³å¯
  - ä¹Ÿå¯ä»¥åœ¨æ ¸å¿ƒæ¨¡å—å‰æ·»åŠ  '**node:**' ï¼ˆå¯ä»¥åŠ å¿«æ¨¡å—çš„æ£€ç´¢æ—¶é—´ï¼‰

```javascript
/* index.js */ // [!code ++]
// å¼•å…¥ // [!code ++]
const path = require("path"); // å¯¼å…¥æ ¸å¿ƒæ¨¡å—
const path = require("node:path"); // æ•ˆæœåŒä¸Š

const m1 = require("./m1");
console.log(m1); // è¾“å‡ºï¼š{ a: 'å­™æ‚Ÿç©º' }
console.log(m1.a); // è¾“å‡ºï¼šå­™æ‚Ÿç©º

/* m1.js */ // [!code ++]
// å¯¼å‡º // [!code ++]
/*
  åœ¨å®šä¹‰æ¨¡å—æ—¶ï¼Œæ¨¡å—ä¸­çš„å†…å®¹é»˜è®¤æ˜¯ä¸èƒ½è¢«å¤–éƒ¨çœ‹åˆ°çš„ï¼Œå¯ä»¥é€šè¿‡exportsæ¥è®¾ç½®è¦å‘å¤–éƒ¨æš´éœ²çš„å†…å®¹ã€‚

  è®¿é—®exportsçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š
    - exports
    - module.exports

  å½“æˆ‘ä»¬åœ¨å…¶ä»–æ¨¡å—ä¸­å¼•å…¥å½“å‰æ¨¡å—æ—¶ï¼Œrequire å‡½æ•°è¿”å›çš„å°±æ˜¯ exportsï¼Œå¯ä»¥å°†å¸Œæœ›æš´éœ²ç»™å¤–éƒ¨æ¨¡å—çš„å†…å®¹è®¾ç½®ä¸º exports çš„å±æ€§ã€‚
*/
let a = "å­™æ‚Ÿç©º";

// module.exports === export
export.a = a;
// æˆ–è€…
module.exports = {
  a: a,
}
```

æŒ‰éœ€åŠ è½½

```javascript
/* index.js */ // [!code ++]
// å¼•å…¥ // [!code ++]
const name = require("./m1").name;
// æˆ–è€…
const { name } = require("./m1"); // è§£æ„èµ‹å€¼

/* m2.js */ // [!code ++]
// å¯¼å‡º // [!code ++]
module.exports = {
  name: "å­™æ‚Ÿç©º",
  age: 18,
  gender: "ç”·",
};
```

**æ–‡ä»¶å¤¹ä½œä¸ºæ¨¡å—**æ—¶ï¼š

å½“æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä½œä¸ºæ¨¡å—æ—¶ï¼Œæ–‡ä»¶å¤¹ä¸­å¿…é¡»æœ‰ä¸€ä¸ªæ¨¡å—çš„ä¸»æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å¤¹ä¸­å«æœ‰ package.json æ–‡ä»¶ä¸”æ–‡ä»¶ä¸­è®¾ç½® main å±æ€§ï¼Œåˆ™ main å±æ€§æŒ‡å®šçš„æ–‡ä»¶ä¼šæˆä¸ºä¸»æ–‡ä»¶ï¼Œå¯¼å…¥æ¨¡å—æ—¶å°±æ˜¯å¯¼å…¥è¯¥æ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰ package.jsonï¼Œåˆ™ node ä¼šæŒ‰ç…§ index.jsã€index.node çš„é¡ºåºå¯»æ‰¾ä¸»æ–‡ä»¶ã€‚

**æ¨¡å—çš„åŒ…è£…**ï¼š

```javascript
(function (exports, require, module, __filename, __dirname) {
  // æ¨¡å—ä»£ç ä¼šè¢«æ”¾åˆ°è¿™é‡Œ
});
```

æ¯ä¸€ä¸ª CommonJS æ¨¡å—åœ¨æ‰§è¡Œæ—¶ï¼Œå¤–å±‚éƒ½ä¼šè¢«å¥—ä¸Šä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹‹æ‰€ä»¥èƒ½åœ¨ CommonJS æ¨¡å—ä¸­ä½¿ç”¨ exportsã€require å¹¶ä¸æ˜¯å› ä¸ºå®ƒä»¬æ˜¯å…¨å±€å˜é‡ã€‚å®ƒä»¬å®é™…ä¸Šä»¥å‚æ•°çš„å½¢å¼ä¼ é€’è¿›æ¨¡å—çš„ã€‚

å‚æ•°ï¼š

- exports ç”¨æ¥è®¾ç½®æ¨¡å—å‘å¤–éƒ¨æš´éœ²çš„å†…å®¹
- require ç”¨æ¥å¼•å…¥æ¨¡å—çš„æ–¹æ³•
- module å½“å‰æ¨¡å—çš„å¼•ç”¨
- \_\_filename æ¨¡å—çš„è·¯å¾„
- \_\_dirname æ¨¡å—æ‰€åœ¨ç›®å½•çš„è·¯å¾„

### ESModule

2015 å¹´éšç€ ES6 æ ‡å‡†çš„å‘å¸ƒï¼ŒES çš„å†…ç½®æ¨¡å—åŒ–ç³»ç»Ÿä¹Ÿåº”è¿è€Œç”Ÿï¼Œå¹¶ä¸”åœ¨ Node.js ä¸­åŒæ ·ä¹Ÿæ”¯æŒ ES æ ‡å‡†çš„æ¨¡å—åŒ–ã€‚è¯´æ¥è¯´å»ä½¿ç”¨æ¨¡å—åŒ–æ— ééœ€è¦æ³¨æ„ä¸¤ä»¶äº‹å¯¼å‡ºå’Œå¼•å…¥ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œnode çš„æ¨¡å—åŒ–æ˜¯ CommonJSï¼Œå¦‚æƒ³è¦ä½¿ç”¨ ESModuleï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ã€‚

- ä½¿ç”¨ .mjs ä½œä¸ºæ–‡ä»¶æ‰©å±•å
- åœ¨ package.json ä¸­è®¾ç½® type å±æ€§ä¸º module

```javascript
/* m3.mjs */ // [!code ++]
// å¯¼å‡º // [!code ++]
export let name = "çŒªå…«æˆ’";
export let information = {
  age: 19,
  gender: "ç”·",
};
// å®šä¹‰é»˜è®¤æ¨¡å—
// ä¸€ä¸ªæ¨¡å—åªèƒ½æœ‰ä¸€ä¸ªé»˜è®¤æ¨¡å—
export default function sayHello() {
  console.log("Hello");
}

/* index.js */ // [!code ++]
// å¯¼å…¥ // [!code ++]
import { name, information } from "./m3.mjs";
// æˆ–è€…
import { name as n, information as i } from "./m3.mjs"; // ä¸ºå¯¼å…¥çš„æ¨¡å—é‡æ–°å‘½å
// æˆ–è€…
import * as m3 from "./m3.mjs"; // å¯¼å…¥æ‰€æœ‰æ¨¡å—ï¼Œå¹¶èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ã€‚
// æˆ–è€…
import sayHello, { name, information } from "./m3.mjs"; // å¯¼å…¥é»˜è®¤æ¨¡å—
```

:::tip
é€šè¿‡ ESMï¼Œå¯¼å…¥çš„å†…å®¹éƒ½æ˜¯å¸¸é‡ï¼›

ESM éƒ½æ˜¯è¿è¡Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹çš„ï¼›

ESM åœ¨æµè§ˆå™¨ä¸­åŒæ ·æ”¯æŒï¼Œä½†æ˜¯å¯èƒ½ä¼šå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼ˆIEï¼‰ï¼Œä¸ºæ­¤é€šå¸¸ä¼šç»“åˆæ‰“åŒ…å·¥å…·ä½¿ç”¨ï¼›
:::

:::tip
`.cjs` æ–‡ä»¶æ˜¯ CommonJS æ¨¡å—çš„æ–‡ä»¶æ‰©å±•åï¼Œ`.mjs` æ–‡ä»¶æ˜¯ ESModule æ¨¡å—çš„æ–‡ä»¶æ‰©å±•åã€‚
:::

## æ ¸å¿ƒæ¨¡å—

æ ¸å¿ƒæ¨¡å—æ˜¯ node ä¸­çš„å†…ç½®æ¨¡å—ï¼Œè¿™äº›æ¨¡å—æœ‰çš„å¯ä»¥ç›´æ¥åœ¨ node ä¸­ä½¿ç”¨ï¼Œæœ‰çš„ç›´æ¥å¼•å…¥å³å¯ä½¿ç”¨ã€‚

### process

process

- è¡¨ç¤ºå½“å‰çš„ node è¿›ç¨‹
- é€šè¿‡è¯¥å¯¹è±¡å¯ä»¥è·å–è¿›ç¨‹ä¿¡æ¯ï¼Œæˆ–è€…å¯¹è¿›ç¨‹è¿›è¡Œæ“ä½œ
- å¦‚ä½•ä½¿ç”¨
  - 1. process æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
  - 2. å±æ€§å’Œæ–¹æ³•
    - process.exit([StatusCode])
      - ç»“æŸå½“å‰è¿›ç¨‹ï¼Œç»ˆæ­¢ node
    - process.nextTick(callback [, ...args])
      - å°†å‡½æ•°æ’å…¥åˆ° tick é˜Ÿåˆ—ä¸­
      - tick é˜Ÿåˆ—ä¸­çš„ä»£ç ï¼Œä¼šåœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¹‹å‰æ‰§è¡Œï¼Œå³ä¼šåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—å’Œå®ä»»åŠ¡é˜Ÿåˆ—çš„ä¹‹å‰æ‰§è¡Œ

```javascript
setTimeout(() => {
  console.log(1); // å®ä»»åŠ¡é˜Ÿåˆ—
});

queueMicrotask(() => {
  console.log(2); // å¾®ä»»åŠ¡é˜Ÿåˆ—
});

process.nextTick(() => {
  console.log(3); // tick é˜Ÿåˆ—
});

console.log(4); // è°ƒç”¨æ ˆ
```

:::details ç»“æœ

```javascript
// 4 3 2 1
```

:::

### path

path

- è¡¨ç¤ºè·¯å¾„
- é€šè¿‡è¯¥å¯¹è±¡ï¼Œå¯ä»¥è·å–å„ç§è·¯å¾„
- å¦‚ä½•ä½¿ç”¨
  - 1. ä¸æ˜¯å…¨å±€å˜é‡ï¼Œéœ€è¦è¿›è¡Œå¼•å…¥
    - const path = require("node:path");
  - 2. å±æ€§å’Œæ–¹æ³•
    - path.resolve([...paths])
      - ç”¨æ¥ç”Ÿæˆä¸€ä¸ªç»å¯¹è·¯å¾„

```javascript
const path = require("path");
let href = "";

href = path.resolve(); // è·å–å½“å‰çš„å·¥ä½œç›®å½•ç»å¯¹è·¯å¾„ï¼Œç”±äºè¿è¡Œçš„ä½ç½®ä¸åŒï¼Œè°ƒè¯•æ§åˆ¶å°å’Œç»ˆç«¯å¾—åˆ°çš„è·¯å¾„ä¼šæœ‰å‡ºå…¥ï¼Œå­˜åœ¨ä¸ç¡®å®šæ€§
console.log(href); // è¾“å‡º C:\Users\23248\Desktop\apecode

href = path.resolve("./hello.js"); // è·å– hello æ¨¡å—çš„ç»å¯¹è·¯å¾„ï¼Œå­˜åœ¨ä¸ç¡®å®šæ€§
console.log(href); // è¾“å‡º C:\Users\23248\Desktop\apecode\hello.js

href = path.resolve("C:\\Users\\23248\\Desktop\\apecode", "./hello.js"); // æŒ‡å®šå·¥ä½œç›®å½•ç»å¯¹è·¯å¾„å’Œæ¨¡å—çš„ç›¸å¯¹è·¯å¾„ï¼Œè®¡ç®—å‡ºè¯¥æ¨¡å—çš„ç»å¯¹è·¯å¾„ï¼Œå±äºç¡¬ç¼–ç 
console.log(href); // C:\Users\23248\Desktop\apecode\hello.js

href = path.resolve(__dirname, "./hello.js"); // æœ€ç»ˆæ¨¡å—çš„ç»å¯¹è·¯å¾„è·å–æ–¹å¼ã€æ¨èã€‘
console.log(href); // C:\Users\23248\Desktop\apecode\hello.js
```

### fs

fs(File System)

- æ–‡ä»¶ç³»ç»Ÿ
- ç”¨æ¥å¸®åŠ© node æ¥æ“ä½œç£ç›˜ä¸­çš„æ–‡ä»¶ï¼ŒI/O æ“ä½œï¼ˆinput outputï¼‰
- å¦‚ä½•ä½¿ç”¨
  - 1. ä¸æ˜¯å…¨å±€å˜é‡ï¼Œéœ€è¦è¿›è¡Œå¼•å…¥
    - const fs = require("node:fs")
  - 2. å±æ€§å’Œæ–¹æ³•ï¼ˆå›è°ƒå‡½æ•°ç‰ˆæœ¬ï¼‰
    - fs.readFile(path[, options], callback) è¯»å–æ–‡ä»¶
    - fs.appendFile(path[, options], data[, encoding], callback) åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæˆ–è¿½åŠ æ–°æ•°æ®
    - fs.mkdir(path[, options], callback) åˆ›å»ºç›®å½•
    - fs.rmdir(path[, options], callback) åˆ é™¤ç›®å½•
    - fs.rm(path[, options], callback) åˆ é™¤æ–‡ä»¶
    - fs.rename(oldPath, newPath, callback) é‡å‘½åæ–‡ä»¶æˆ–ç›®å½•ï¼ˆå¤åˆ¶ï¼‰
    - fs.copyFile(src, dest, callback) å¤åˆ¶æ–‡ä»¶ï¼ˆå‰ªåˆ‡ï¼‰

åŸºäº fs æ¨¡å—çš„ readFile æ–¹æ³•ï¼Œåˆ†åˆ«é€šè¿‡åŒæ­¥æ–¹æ³•ï¼Œå¼‚æ­¥æ–¹æ³•ï¼ŒPromise å†™æ³•ï¼Œä»¥åŠ async/await å†™æ³•æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚

```javascript
const path = require("node:path");
const fs = require("node:fs");
const fsp = require("node:fs/promises"); // æ³¨æ„ï¼Œéœ€è¦ node v14.0.0 åŠä»¥ä¸Š

// åŒæ­¥æ–¹æ³•ï¼Œä¼šé˜»å¡åé¢çš„ä»£ç æ‰§è¡Œ
try {
  const buffer = fs.readFileSync(path.join(__dirname, "./hello.txt"));
  console.log("æ–‡ä»¶å†…å®¹:", buffer.toString());
} catch (err) {
  console.error("è¯»å–æ–‡ä»¶å‡ºé”™:", err);
}

// å¼‚æ­¥æ–¹æ³•
fs.readFile(path.join(__dirname, "./hello.txt"), (err, buffer) => {
  if (err) {
    console.error("è¯»å–æ–‡ä»¶å‡ºé”™:", err);
    return;
  }
  console.log("æ–‡ä»¶å†…å®¹:", buffer.toString());
});

// å¼‚æ­¥æ–¹æ³•ï¼ŒPromise
fsp
  .readFile(path.join(__dirname, "./hello.txt"))
  .then((buffer) => {
    console.log("æ–‡ä»¶å†…å®¹:", buffer.toString());
  })
  .catch((err) => {
    console.error("è¯»å–æ–‡ä»¶å‡ºé”™:", err);
  });

// å¼‚æ­¥æ–¹æ³•ï¼Œasync/await
(async () => {
  try {
    const buffer = await fsp.readFile(path.join(__dirname, "./hello.txt"));
    console.log("æ–‡ä»¶å†…å®¹:", buffer.toString());
  } catch (err) {
    console.log(err);
  }
})();
```

æµ‹è¯•æ–‡ä»¶

```txt
ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥ä¸Šè¯¾
```

åŸºäº fs.readFile å’Œ fs.appendFile å®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚

```javascript
const path = require("node:path");
const fsp = require("node:fs/promises");

fsp
  .readFile("C:\\Users\\23248\\Desktop\\test.jpg")
  .then((buffer) => {
    console.log(buffer);
    return fsp.appendFile(path.resolve(__dirname, "./test-img-copy.jpg"), buffer);
  })
  .then(() => {
    console.log("å¤åˆ¶æˆåŠŸ");
  })
  .catch((err) => {
    console.log("å¤åˆ¶å¤±è´¥ï¼š", err);
  });
```

## åŒ…ç®¡ç†å™¨

> éšç€é¡¹ç›®å¤æ‚åº¦çš„æå‡ï¼Œåœ¨å¼€å‘ä¸­ä¸å¯èƒ½æ‰€æœ‰çš„ä»£ç éƒ½è¦æ‰‹åŠ¨ä¸€è¡Œä¸€è¡Œçš„ç¼–å†™ï¼Œäºæ˜¯æˆ‘ä»¬å°±éœ€è¦ä¸€äº›å°†ä¸€äº›ç°æˆå†™å¥½çš„ä»£ç å¼•å…¥åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆå¼€å‘ï¼Œå°±åƒæ˜¯æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ jQueryã€‚jQuery è¿™ç§å¤–éƒ¨ä»£ç åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¹‹ä¸ºåŒ…ã€‚

### npm

node ä¸­çš„åŒ…ç®¡ç†å±€å«åš npmï¼ˆnode package manageï¼‰ï¼Œnpm æ˜¯ä¸–ç•Œä¸Šæœ€å¤§çš„åŒ…ç®¡ç†åº“ã€‚

npm ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š

1. npm ç½‘ç«™ ï¼ˆé€šè¿‡ npm ç½‘ç«™å¯ä»¥æŸ¥æ‰¾åŒ…ï¼Œä¹Ÿå¯ä»¥ç®¡ç†è‡ªå·±å¼€å‘æäº¤åˆ° npm ä¸­çš„åŒ…ã€‚https://www.npmjs.com/
2. npm CLIï¼ˆCommand Line Interface å³ å‘½ä»¤è¡Œï¼‰ï¼ˆé€šè¿‡ npm çš„å‘½ä»¤è¡Œï¼Œå¯ä»¥åœ¨è®¡ç®—æœºä¸­æ“ä½œ npm ä¸­çš„å„ç§åŒ…ï¼ˆä¸‹è½½å’Œä¸Šä¼ ç­‰ï¼‰ï¼‰
3. ä»“åº“ï¼ˆä»“åº“ç”¨æ¥å­˜å‚¨åŒ…ä»¥åŠåŒ…ç›¸å…³çš„å„ç§ä¿¡æ¯ï¼‰

### package.json

package.json é¡¾åæ€ä¹‰ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªç”¨æ¥æè¿°åŒ…çš„ json æ–‡ä»¶ï¼Œnode é€šè¿‡è¯¥æ–‡ä»¶å¯¹é¡¹ç›®è¿›è¡Œæè¿°ï¼Œæ¯ä¸€ä¸ª node é¡¹ç›®å¿…é¡»è¦æœ‰ã€‚å®ƒé‡Œè¾¹éœ€è¦ä¸€ä¸ª json æ ¼å¼çš„æ•°æ®ï¼ˆjson å¯¹è±¡ï¼‰ï¼Œåœ¨ json æ–‡ä»¶ä¸­é€šè¿‡å„ä¸ªå±æ€§æ¥æè¿°åŒ…çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåƒåŒ…åã€ç‰ˆæœ¬ã€ä¾èµ–ç­‰åŒ…ç›¸å…³çš„ä¸€åˆ‡ä¿¡æ¯ã€‚

```json
{
  "name": "desktop",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
```

é…ç½®å±æ€§è¯´æ˜ï¼š

- nameï¼ˆå¿…å¤‡ï¼‰
  - åŒ…çš„åç§°ï¼Œå¯ä»¥åŒ…å«å°å†™å­—æ¯ã€\_å’Œ-
- versionï¼ˆå¿…å¤‡ï¼‰
  - åŒ…çš„ç‰ˆæœ¬ï¼Œéœ€è¦éµä» x.x.x çš„æ ¼å¼
  - è§„åˆ™ï¼š
  - ç‰ˆæœ¬ä» 1.0.0 å¼€å§‹
  - ä¿®å¤é”™è¯¯ï¼Œå…¼å®¹æ—§ç‰ˆï¼ˆè¡¥ä¸ï¼‰1.0.1ã€1.0.2
  - æ·»åŠ åŠŸèƒ½ï¼Œå…¼å®¹æ—§ç‰ˆï¼ˆå°æ›´æ–°ï¼‰1.1.0
  - æ›´æ–°åŠŸèƒ½ï¼Œå½±å“å…¼å®¹ï¼ˆå¤§æ›´æ–°ï¼‰2.0.0
- author
  - åŒ…çš„ä½œè€…ï¼Œæ ¼å¼ï¼šYour Name \<email@example.com\>
- description
  - åŒ…çš„æè¿°
- repository
  - ä»“åº“åœ°å€ï¼ˆgitï¼‰
- scripts
  - è‡ªå®šä¹‰ä¸€äº›å‘½ä»¤
  - start å’Œ test å¯ä»¥ç›´æ¥é€šè¿‡ npm + æ‰§è¡Œï¼Œå…¶ä½™éœ€è¦ npm run + æ‰§è¡Œ

:::tip ç‰ˆæœ¬æè¿°
è®¾ç½®ä¾èµ–é¡¹æ—¶"lodash": "^4.17.21"å‰è¾¹çš„ loadsh è¡¨ç¤ºåŒ…çš„åå­—ï¼Œåè¾¹æ˜¯åŒ…çš„ç‰ˆæœ¬ã€‚"^4.17.21"è¡¨ç¤ºåŒ¹é…æœ€æ–°çš„ 4.x.x çš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯å¦‚æœåæœŸ lodash åŒ…æ›´æ–°åˆ°äº† 4.18.1ï¼Œæˆ‘ä»¬çš„åŒ…ä¹Ÿä¼šä¸€èµ·æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœæ›´æ–°åˆ°äº† 5.0.0ï¼Œæˆ‘ä»¬çš„åŒ…æ˜¯ä¸ä¼šéšä¹‹æ›´æ–°çš„ã€‚å¦‚æœæ˜¯"~4.17.21"ï¼Œ~è¡¨ç¤ºåŒ¹é…æœ€å°ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯ 4.17.xã€‚å¦‚æœæ˜¯"\*"åˆ™è¡¨ç¤ºåŒ¹é…æœ€æ–°ç‰ˆæœ¬ï¼Œå³ x.x.xï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä¸åŠ ä»»ä½•å‰ç¼€ï¼Œè¿™æ ·åªä¼šåŒ¹é…åˆ°å½“å‰ç‰ˆæœ¬ã€‚
:::

### ç›¸å…³å‘½ä»¤

```bash
# 1. åˆå§‹åŒ–é¡¹ç›®
# åˆ›å»º package.json æ–‡ä»¶ï¼ˆéœ€è¦å›ç­”é—®é¢˜ï¼‰
$ npm init
# åˆ›å»º package.json æ–‡ä»¶ï¼ˆæ‰€æœ‰å€¼éƒ½é‡‡ç”¨é»˜è®¤å€¼ï¼‰
$ npm init -y

# 2. ä¸‹è½½åŒ…
# å°†æŒ‡å®šåŒ…ä¸‹è½½åˆ°å½“å‰é¡¹ç›®ä¸­
$ npm install åŒ…å
# å°†æŒ‡å®šåŒ…ä¸‹è½½åˆ°å…¨å±€ï¼Œå¸¸å¸¸ä½¿ç”¨äºè„šæ‰‹æ¶ç­‰
$ npm install åŒ…å -g
# è‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–
$ npm install

# 3. å¸è½½åŒ…
# å¸è½½æŒ‡å®šåŒ…
$ npm uninstall åŒ…å
# å¸è½½æŒ‡å®šå…¨å±€åŒ…
$ npm uninstall åŒ…å -g
```

```shell
# å®‰è£…æŒ‡å®šç‰ˆæœ¬
$ npm install lodash@3.2.0

# å®‰è£…å¤§äºçš„ç‰ˆæœ¬
$ npm install lodash@"> 3.2.0"
```

:::tip npm install æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1. å°†åŒ…ä¸‹è½½å½“å‰é¡¹ç›®çš„ node_modules ç›®å½•ä¸‹
2. ä¼šåœ¨ package.json çš„ dependencies å±æ€§ä¸­æ·»åŠ ä¸€ä¸ªæ–°å±æ€§ "lodash": "^4.17.21"
3. ä¼šè‡ªåŠ¨æ·»åŠ  package-lock.json æ–‡ä»¶ï¼Œå¸®åŠ©åŠ é€Ÿ npm ä¸‹è½½çš„

:::

### é…ç½®é•œåƒ

```shell
# 1. ä½¿ç”¨å›½å†…é•œåƒ
# ä½¿ç”¨ cnpm
$ npm install -g cnpm --registry=https://registry.npmmirror.com

# 2. ä¿®æ”¹ npm æº
# é…ç½® npm æº
$ npm config set registry https://registry.npmmirror.com

# æŸ¥çœ‹ npm æº
$ npm config get registry

# åˆ é™¤ npm æº
$ npm config delete registry
```

### yarn & pnpm

æˆªæ­¢ç›®å‰ï¼Œå·²ç»æœ‰å››å¤§åŒ…ç®¡ç†å™¨ï¼Œåˆ†åˆ«æ˜¯ npmã€yarnã€pnpm å’Œ bunã€‚

1. npmï¼ˆNode Package Managerï¼‰ï¼š

- npm æ˜¯ Node.js å®˜æ–¹çš„åŒ…ç®¡ç†å·¥å…·ï¼Œæ˜¯ JavaScript ç¤¾åŒºä¸­æœ€å¸¸ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚
- å®ƒå…·æœ‰åºå¤§çš„åŒ…ç”Ÿæ€ç³»ç»Ÿï¼ŒåŒ…å«äº†å‡ ä¹æ‰€æœ‰ JavaScript åŒ…ã€‚
- npm æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®‰è£…ã€å¸è½½ã€æ›´æ–°åŒ…ï¼Œä»¥åŠç®¡ç†é¡¹ç›®çš„ä¾èµ–å…³ç³»ã€‚

2. Yarnï¼š

- Yarn æ˜¯ç”± Facebookã€Googleã€Exponent å’Œ Tilde è”åˆå¼€å‘çš„å¦ä¸€ç§åŒ…ç®¡ç†å·¥å…·ã€‚
- å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯è§£å†³ npm åœ¨æ€§èƒ½å’Œä¸€è‡´æ€§æ–¹é¢çš„ä¸€äº›é—®é¢˜ï¼Œé€šè¿‡å¹¶è¡Œä¸‹è½½ã€æœ¬åœ°ç¼“å­˜å’Œé”æ–‡ä»¶ç­‰åŠŸèƒ½æé«˜äº†åŒ…çš„å®‰è£…é€Ÿåº¦å’Œå¯é æ€§ã€‚
- Yarn å¯ä»¥ä¸ npm å…¼å®¹ï¼Œå¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨ npm å­˜å‚¨åº“ã€‚

3. pnpmï¼š

- pnpm æ˜¯å¦ä¸€ç§åŒ…ç®¡ç†å·¥å…·ï¼Œå®ƒé€šè¿‡å…±äº«ä¾èµ–ï¼Œå‡å°‘äº†é¡¹ç›®é—´çš„é‡å¤ä¾èµ–ï¼Œä»è€Œå‡å°‘äº†ç£ç›˜ç©ºé—´çš„å ç”¨å’Œå®‰è£…æ—¶é—´ã€‚
- pnpm çš„è®¾è®¡ç†å¿µæ˜¯å°½å¯èƒ½åœ°å‡å°‘å†—ä½™ï¼Œä»¥æé«˜æ€§èƒ½å’Œæ•ˆç‡ã€‚

4. Bunï¼š

- Bun æ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒæ–°çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æä¾›æ›´å¿«ã€æ›´ç®€æ´çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥æ›¿ä»£ä¼ ç»Ÿçš„ npmã€Yarn å’Œ pnpmã€‚
- Bun é‡‡ç”¨äº†ä¸€äº›ä¼˜åŒ–ç­–ç•¥ï¼Œä»¥åŠ é€ŸåŒ…çš„å®‰è£…å’Œç®¡ç†è¿‡ç¨‹ï¼ŒåŒæ—¶è¯•å›¾ç®€åŒ–ç”¨æˆ·ç•Œé¢å’Œå‘½ä»¤ã€‚

[yarn å®˜ç½‘ ğŸ‘‰](https://yarnpkg.com/)

[pnpm å®˜ç½‘ ğŸ‘‰](https://pnpm.io/)

[bun å®˜ç½‘ ğŸ‘‰](https://bun.sh.cn/)

å‘½ä»¤

:::code-group

```shell [yarn]
# å®‰è£…
$ npm install -g yarn

# æŸ¥çœ‹ç‰ˆæœ¬
$ yarn -v

# åˆå§‹åŒ–é¡¹ç›®
$ yarn init

# å®‰è£…ä¾èµ–
$ yarn add xxx

# å¸è½½ä¾èµ–
$ yarn remove xxx

# å®‰è£…å¼€å‘ä¾èµ–
$ yarn add -D xxx

# è¿˜åŸä¾èµ–
$ yarn install

# æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
$ yarn run

# æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
$ yarn <æŒ‡ä»¤>

# å…¨å±€å®‰è£…
$ yarn global add

# å…¨å±€ç§»é™¤
$ yarn global remove

# å…¨å±€å®‰è£…ç›®å½•
$ yarn global bin

# é•œåƒé…ç½®
$ yarn config set registry https://registry.npmmirror.com

# é•œåƒæ¢å¤
$ yarn config delete registry
```

```shell [pnpm]
# å®‰è£…
$ npm install -g pnpm

# æŸ¥çœ‹ç‰ˆæœ¬
$ pnpm -v

# åˆå§‹åŒ–é¡¹ç›®
$ pnpm init

# å®‰è£…ä¾èµ–
$ pnpm add xxx

# å¸è½½ä¾èµ–
$ pnpm remove xxx

# å®‰è£…å¼€å‘ä¾èµ–
$ pnpm add -D xxx

# å®‰è£…å…¨å±€åŒ…
$ pnpm add -g xxx

# è¿˜åŸä¾èµ–
$ pnpm install

# é•œåƒé…ç½®
$ pnpm config set registry https://registry.npmmirror.com

# é•œåƒæ¢å¤
$ pnpm config delete registry
```

### corepack

:::

```shell
# åœ¨ node v 16.0.0 ä¹‹åï¼Œæœ‰ä¸€ä¸ª corepack å·¥å…·ï¼Œå…¶åŒæ—¶å†…ç½®äº† yarn å’Œ pnpm
# é»˜è®¤å…³é—­çŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯
$ corepack enable

# åˆ‡æ¢ corepack yarn ä¸º 1.x.x ç‰ˆæœ¬
$ corepack prepare yarn@1.x.x --activate

# åˆ‡æ¢ corepack yarn æœ€æ–°ç‰ˆæœ¬
$ corepack prepare yarn@latest --activate
```

## Http åè®®

### ä¸¤é“é¢è¯•é¢˜

:::tip å½“åœ¨æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ä»¥åå‘ä»€ä¹ˆï¼Ÿ

1. DNS è§£æï¼Œè·å–ç½‘ç«™çš„ ip åœ°å€
2. æµè§ˆå™¨éœ€è¦å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼ˆtcp/ipï¼‰ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰
3. å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ˆhttp åè®®ï¼‰
4. æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ï¼ˆhttp åè®®ï¼‰
5. æµè§ˆå™¨å°†å“åº”çš„é¡µé¢æ¸²æŸ“
6. æ–­å¼€ä¸æœåŠ¡å™¨çš„è¿æ¥ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰

:::

:::tip å®¢æˆ·ç«¯å¦‚ä½•å’ŒæœåŠ¡å™¨å»ºç«‹ï¼ˆæ–­å¼€ï¼‰è¿æ¥

- ä¸‰æ¬¡æ¡æ‰‹ï¼ˆå»ºç«‹è¿æ¥ï¼‰

  1. å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¿æ¥è¯·æ±‚ï¼ˆSYNï¼‰ï¼›
  2. æœåŠ¡å™¨æ”¶åˆ°è¿æ¥è¯·æ±‚ï¼Œå‘å®¢æˆ·ç«¯è¿”å›æ¶ˆæ¯ï¼ˆACK + SYNï¼‰ï¼›
  3. å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€åŒæ„è¿æ¥çš„ä¿¡æ¯ï¼ˆSYNï¼‰ï¼›

- å››æ¬¡æŒ¥æ‰‹ï¼ˆæ–­å¼€è¿æ¥ï¼‰

  1. å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ–­å¼€è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ—¶æ•°æ®å‘é€å®Œæ¯•ï¼Œè¯·æ±‚æ–­å¼€è¿æ¥ï¼ˆFINï¼‰ï¼›
  2. æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®ï¼Œæ”¶åˆ°è¯·æ±‚ï¼ˆACKï¼‰ï¼›
  3. æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®ï¼Œæ•°æ®æ¥æ”¶å®Œæˆï¼Œå¯ä»¥æ–­å¼€ï¼ˆFIN + ACKï¼‰ï¼›
  4. å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼ŒåŒæ„æ–­å¼€è¿æ¥ï¼ˆACKï¼‰ï¼›

:::

### ç½‘ç»œé€šè®¯

`TCP/IP åè®®æ—`ä¸­åŒ…å«äº†ä¸€ç»„åè®®ï¼Œè¿™ç»„åè®®è§„å®šäº†äº’è”ç½‘ä¸­æ‰€æœ‰çš„é€šè®¯çš„ç»†èŠ‚ã€‚

`ç½‘ç»œé€šè®¯`è¿‡ç¨‹ç”±å››å±‚ç»„æˆï¼š

- `åº”ç”¨å±‚`: HTTPã€FTPã€SMTPã€DNS
  - è½¯ä»¶å±‚é¢ï¼Œæµè§ˆå™¨ã€æœåŠ¡å™¨éƒ½å±äºåº”ç”¨å±‚
- `ä¼ è¾“å±‚`: TCPã€UDP
  - è´Ÿè´£å¯¹æ•°æ®æ‹†åˆ†ï¼ŒæŠŠå¤§æ•°æ®æ‹†åˆ†ä¸ºä¸€ä¸ªä¸ªå°åŒ…ï¼ˆè¯·æ±‚æ—¶ï¼‰ï¼Œè´Ÿè´£å¯¹æ•°æ®åˆå¹¶ï¼Œå°†ä¸€ä¸ªä¸ªå°åŒ…åˆå¹¶æˆå¤§æ•°æ®ï¼ˆæ¥æ”¶æ—¶ï¼‰
- `ç½‘ç»œå±‚`: IPã€ICMPã€ARP
  - è´Ÿè´£ç»™æ•°æ®åŒ…æ·»åŠ ä¿¡æ¯ï¼ˆè¯·æ±‚æ—¶ï¼‰ï¼›è´Ÿè´£ç»™æ•°æ®åŒ…ç§»é™¤ä¿¡æ¯ï¼ˆæ¥æ”¶æ—¶ï¼‰
- `æ•°æ®é“¾è·¯å±‚`: MAC
  - ä¼ è¾“æ•°æ®

å…¶ä¸­ï¼Œ`HTTP åè®®ï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰`æ˜¯åº”ç”¨å±‚çš„åè®®ï¼Œç”¨æ¥è§„å®šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šè®¯è§„åˆ™ï¼Œå³è§„å®š`æŠ¥æ–‡`æ ¼å¼ã€‚

### æŠ¥æ–‡

æŠ¥æ–‡ï¼ˆmessageï¼‰ï¼Ÿ

æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šè®¯æ—¶åŸºäº`è¯·æ±‚å’Œå“åº”`

- æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€`è¯·æ±‚ï¼ˆrequestï¼‰`ï¼Œç›¸å½“äºå‘ä¿¡
- æœåŠ¡å™¨å‘æµè§ˆå™¨è¿”å›`å“åº”ï¼ˆresponseï¼‰`ï¼Œç›¸å½“äºå›ä¿¡

### æŠ¥æ–‡ç±»å‹

æŠ¥æ–‡ç±»å‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š

- `è¯·æ±‚æŠ¥æ–‡ï¼ˆrequestï¼‰`: å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æŠ¥æ–‡ç§°ä¸ºè¯·æ±‚æŠ¥æ–‡ã€‚
- `å“åº”æŠ¥æ–‡ï¼ˆresponseï¼‰`: æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯çš„æŠ¥æ–‡ç§°ä¸ºå“åº”æŠ¥æ–‡ã€‚

#### è¯·æ±‚æŠ¥æ–‡

- è¯·æ±‚é¦–è¡Œ
- è¯·æ±‚å¤´
- ç©ºè¡Œ
- è¯·æ±‚ä½“

```javascript
/* è¯·æ±‚æŠ¥æ–‡ç¤ºä¾‹ */
// GET /07_http%E5%8D%8F%E8%AE%AE/01_http%E5%8D%8F%E8%AE%AE.html?username=sunwukong HTTP/1.1
// Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
// Accept-Encoding: gzip, deflate, br
// Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,la;q=0.7
// Cache-Control: max-age=0
// Connection: keep-alive
// Host: 127.0.0.1:5500
// If-Modified-Since: Thu, 27 Oct 2022 11:10:28 GMT
// If-None-Match: W/"1b8-1841922e832"
// Referer: http://127.0.0.1:5500/07_http%E5%8D%8F%E8%AE%AE/01_http%E5%8D%8F%E8%AE%AE.html?username=sunwukong
// Sec-Fetch-Dest: document
// Sec-Fetch-Mode: navigate
// Sec-Fetch-Site: same-origin
// Upgrade-Insecure-Requests: 1
// User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36
// sec-ch-ua: "Chromium";v="106", "Google Chrome";v="106", "Not;A=Brand";v="99"
// sec-ch-ua-mobile: ?0
// sec-ch-ua-platform: "Windows"
```

åˆ†æï¼š

- `è¯·æ±‚é¦–è¡Œ`: è¯·æ±‚é¦–è¡Œå°±æ˜¯è¯·æ±‚æŠ¥æ–‡çš„ç¬¬ä¸€è¡Œ;
  - GET /index.html?username=sunwukong HTTP/1.1
    - 1. GET è¡¨ç¤ºå‘é€ get è¯·æ±‚
    - 2. /index.html?username=sunwukong è¡¨ç¤ºè¯·æ±‚èµ„æºè·¯å¾„ï¼Œå…¶ä¸­ '?' åé¢çš„å†…å®¹å«åš`æŸ¥è¯¢å­—ç¬¦ä¸²`
    - 3. HTTP/1.1 è¡¨ç¤ºä½¿ç”¨ http åè®®çš„ 1.1 ç‰ˆæœ¬
- `è¯·æ±‚å¤´`: è¯·æ±‚å¤´æ˜¯é”®å€¼å¯¹ç»“æ„ï¼Œç”¨æ¥å‘Šè¯‰æœåŠ¡å™¨æˆ‘ä»¬æµè§ˆå™¨çš„ä¿¡æ¯;
  - Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,_/_;q=0.8,application/signed-exchange;v=b3;q=0.9
    - Accept æµè§ˆå™¨å¯ä»¥æ¥å—çš„æ–‡ä»¶ç±»å‹
    - Accept-Encoding æµè§ˆå™¨å…è®¸çš„å‹ç¼©çš„ç¼–ç 
    - User-Agent ç”¨æˆ·ä»£ç†ï¼Œå®ƒæ˜¯ä¸€æ®µç”¨æ¥æè¿°æµè§ˆå™¨ä¿¡æ¯çš„å­—ç¬¦ä¸²
- `ç©ºè¡Œ`: ç”¨æ¥åˆ†éš”è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“;
- `è¯·æ±‚ä½“`: get æ²¡æœ‰ï¼Œpost é€šè¿‡è¯·æ±‚ä½“æ¥å‘é€æ•°æ®;

:::tip

| è¯·æ±‚æ–¹å¼ |               ä¼ å‚æ–¹å¼               |                                           é•¿åº¦é™åˆ¶                                            |
| :------: | :----------------------------------: | :-------------------------------------------------------------------------------------------: |
|   Get    | é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²å‘é€æ•°æ®ï¼ŒURL å¯ä»¥çœ‹åˆ° |  HTTP åè®®å¹¶æ²¡æœ‰å¯¹ URL é•¿åº¦é™åˆ¶ï¼Œä¸»è¦çš„é™åˆ¶æ¥æºäºç‰¹å®šçš„æµè§ˆå™¨å’ŒæœåŠ¡å™¨ã€‚2083 ä¸ªå­—ç¬¦ IE æ ‡å‡†ã€‚  |
|   POST   |   é€šè¿‡è¯·æ±‚ä½“å‘é€æ•°æ®ï¼ŒURL æ— æ³•æŸ¥çœ‹   | HTTP åè®®è§„èŒƒä¹Ÿæ²¡æœ‰è¿›è¡Œå¤§å°é™åˆ¶ï¼Œèµ·é™åˆ¶ä½œç”¨çš„æ˜¯æœåŠ¡å™¨çš„å¤„ç†ç¨‹åºçš„å¤„ç†èƒ½åŠ›ã€‚ã€‚Tomcat é»˜è®¤ 2Mã€‚ |

[å…³äº HTTP GET/POST è¯·æ±‚å‚æ•°é•¿åº¦æœ€å¤§å€¼çš„ä¸€ä¸ªç†è§£è¯¯åŒº - jasonhsu9](https://www.jianshu.com/p/ea99c1e4f6a4)

:::

#### å“åº”æŠ¥æ–‡

- å“åº”é¦–è¡Œ
- å“åº”å¤´
- ç©ºè¡Œ
- å“åº”ä½“

```javascript
/* å“åº”æŠ¥æ–‡ç¤ºä¾‹ */
// HTTP/1.1 200 OK
// Vary: Origin
// Access-Control-Allow-Credentials: true
// Accept-Ranges: bytes
// Cache-Control: public, max-age=0
// Last-Modified: Thu, 27 Oct 2022 11:31:54 GMT
// ETag: W/"20c-18419368696"
// Content-Type: text/html; charset=UTF-8
// Content-Length: 2017
// Date: Thu, 27 Oct 2022 11:52:29 GMT
// Connection: keep-alive
// Keep-Alive: timeout=5
```

åˆ†æï¼š

- `å“åº”é¦–è¡Œ`: å“åº”æŠ¥æ–‡çš„ç¬¬ä¸€è¡Œ;
  - HTTP/1.1 200 OK
  - 200 å“åº”çŠ¶æ€ç 
  - ok å¯¹å“åº”çŠ¶æ€ç çš„æè¿°
  - å“åº”çŠ¶æ€ç 
    - 1xx è¯·æ±‚å¤„ç†ä¸­
    - 2xx è¡¨ç¤ºæˆåŠŸ
    - 3xx è¡¨ç¤ºè¯·æ±‚çš„é‡å®šå‘
    - 4xx è¡¨ç¤ºå®¢æˆ·ç«¯é”™è¯¯
    - 5xx è¡¨ç¤ºæœåŠ¡å™¨çš„é”™è¯¯
- `å“åº”å¤´`: æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„åå€¼å¯¹ç»“æ„ï¼Œç”¨æ¥å‘Šè¯‰æµè§ˆå™¨å“åº”çš„ä¿¡æ¯;
  - Content-Type ç”¨æ¥æè¿°å“åº”ä½“çš„ç±»å‹
  - Content-Length ç”¨æ¥æè¿°å“åº”ä½“å¤§å°
  - Content-Type: text/html; charset=UTF-8
  - Content-Length: 2017
- `ç©ºè¡Œ`: ç”¨æ¥åˆ†éš”å“åº”å¤´å’Œå“åº”ä½“;
- `å“åº”ä½“`: å“åº”ä½“å°±æ˜¯æœåŠ¡å™¨è¿”å›ç»™å®¢æˆ·ç«¯çš„å†…å®¹;

## Express

Fast, unpinionated, minimalist web framework for Node.js

Express æ˜¯ä¸€ä¸ªåŸºäº Node.js å¹³å°çš„ web åº”ç”¨å¼€å‘æ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—å¼ºå¤§ç‰¹æ€§å¸®åŠ©ä½ åˆ›å»ºå„ç§ Web å’Œç§»åŠ¨è®¾å¤‡åº”ç”¨ã€‚

Express æ¡†æ¶æ ¸å¿ƒç‰¹æ€§ï¼š

- å¯ä»¥è®¾ç½®ä¸­é—´ä»¶æ¥å“åº” HTTP è¯·æ±‚
- å®šä¹‰äº†è·¯ç”±è¡¨ç”¨äºæ‰§è¡Œä¸åŒçš„ HTTP è¯·æ±‚åŠ¨ä½œ
- å¯ä»¥é€šè¿‡å‘æ¨¡æ¿ä¼ é€’å‚æ•°æ¥åŠ¨æ€æ¸²æŸ“ HTML é¡µé¢

### å®‰è£… & é…ç½® & è®¿é—®

```shell
npm install express
```

```javascript
// å¼•å…¥ express æ¨¡å—
const express = require("express");

// åˆ›å»º express åº”ç”¨ (å¯¹è±¡)
const app = express();

// é…ç½®è·¯ç”±
app.get("/hello", (req, res) => {
  res.send("Hello World");
});

// å¯åŠ¨æœåŠ¡å™¨
// ç›‘å¬ç«¯å£
app.listen(3000, () => {
  console.log("æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ");
});
```

```shell
# æœåŠ¡å™¨å¯åŠ¨åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ 3000 ç«¯å£æ¥è®¿é—®
# åè®®å://ip åœ°å€:ç«¯å£å·/è·¯å¾„
# http://locahost:3000
# http://127.0.0.1:3000
```

### è·¯ç”± & è·¯å¾„ & ä¸­é—´ä»¶

`è·¯ç”±`

å¦‚æœå¸Œæœ›æœåŠ¡å™¨å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œåˆ™éœ€è¦ä¸ºæœåŠ¡å™¨è®¾ç½®`è·¯ç”±`.

`è·¯ç”±`å¯ä»¥æ ¹æ®ä¸åŒçš„è¯·æ±‚æ–¹å¼å’Œè¯·æ±‚åœ°å€æ¥å¤„ç†ç”¨æˆ·çš„è¯·æ±‚.

app.method([è·¯å¾„], callback) æ–¹æ³•ç”¨æ¥è®¾ç½®`è·¯ç”±`

- è·¯ç”±å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ¥æ”¶åˆ°`ä¸‰ä¸ªå‚æ•°`
- request ç”¨æˆ·çš„è¯·æ±‚ä¿¡æ¯ï¼Œè¯·æ±‚æŠ¥æ–‡
- response æœåŠ¡å™¨çš„å“åº”ä¿¡æ¯
- next å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨å‡½æ•°åï¼Œå¯ä»¥è§¦å‘åç»­çš„ä¸­é—´é—´ï¼Œä¸”ä¸èƒ½åœ¨å“åº”å¤„ç†å®Œæ¯•åä½¿ç”¨

ä¾‹å¦‚

```javascript
app.get("/", (request, response) => {
  // 1.å¤„ç†è¯·æ±‚ï¼ˆrequestï¼‰
  // 2.å“åº”è¯·æ±‚ï¼ˆresponseï¼‰
  console.log("æœ‰äººè®¿é—®æˆ‘äº†~");
  response.send("Hello World");

  // å“åº”è¯·æ±‚å¸¸ç”¨æ–¹æ³•
  // response.sendStatue() ç”¨æ¥å‘å®¢æˆ·ç«¯å‘é€å“åº”çŠ¶æ€ç 
  // response.status() ç”¨æ¥è®¾ç½®å“åº”çŠ¶æ€ç ,ä½†ä¸å‘é€
  // response.send() ç”¨æ¥å‘å®¢æˆ·ç«¯å‘é€å“åº”
});
```

`è·¯å¾„`ï¼Œç”¨æ¥åŒ¹é…ç”¨æˆ·è¯·æ±‚çš„åœ°å€ï¼Œå³ app.method() ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°

`ä¸­é—´ä»¶`

> å®é™…åœºæ™¯ï¼š`æƒé™éªŒè¯`

- åœ¨ express ä¸­ï¼Œä½¿ç”¨ app.use([è·¯å¾„]) æ–¹æ³•æ¥æ³¨å†Œ`ä¸­é—´ä»¶`ï¼Œ`ä¸­é—´ä»¶`ä½œç”¨å’Œè·¯ç”±å¾ˆåƒï¼Œç”¨æ³•å¾ˆåƒï¼Œä½†æ˜¯è·¯ç”±ä¸åŒºåˆ†è¯·æ±‚çš„æ–¹å¼ï¼Œåªçœ‹è·¯å¾„ã€‚
- å’Œè·¯ç”±çš„åŒºåˆ«
  - 1. ä¼šåŒ¹é…æ‰€æœ‰è¯·æ±‚ï¼Œä¸åŒºåˆ†è¯·æ±‚æ–¹å¼ï¼Œè·¯å¾„ä¸ºæ¨¡ç³ŠæŸ¥è¯¢ï¼Œéƒ½ä¼šæ‰§è¡Œï¼ˆ`ç±»ä¼¼æ‹¦æˆªå™¨`ï¼‰ã€‚
  - 2. è·¯å¾„è®¾ç½®çˆ¶ç›®å½•ï¼Œå­ç›®å½•éƒ½ä¼šè§¦å‘ï¼Œå¦‚ app.use("/user")ï¼Œè®¿é—® /user å’Œ /user/xxx éƒ½ä¼šè§¦å‘ã€‚

ä¾‹å¦‚

```javascript
app.use("/", (request, response) => {
  console.log("æ”¶åˆ°è¯·æ±‚~");
  response.send("è¿™æ˜¯é€šè¿‡ä¸­é—´ä»¶è¿”å›çš„å“åº”");
});
```

:::tip

```javascript
app.use("/", (request, response) => {
  response.send("è¿™æ˜¯é€šè¿‡ä¸­é—´ä»¶è¿”å›çš„å“åº”");
});
```

ç­‰åŒäº

```javascript
app.use((request, response) => {
  response.send("è¿™æ˜¯é€šè¿‡ä¸­é—´ä»¶è¿”å›çš„å“åº”");
});
```

:::

```javascript
/* 
  è¿è¡Œè¿™é‡Œï¼Œä¼šåªæ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼Œ
  å› ä¸ºç¬¬ä¸€ä¸ªä¸­é—´ä»¶æ²¡æœ‰è°ƒç”¨ next()ï¼Œ
  æ‰€ä»¥ä¸ä¼šæ‰§è¡Œåé¢çš„ä¸­é—´ä»¶
*/
app.use((req, res, next) => {
  console.log("111", Date.now());
  res.send("<h1>111</h1>");
});
app.use((req, res) => {
  console.log("222", Date.now());
  res.send("<h1>222</h1>");
});
app.use((req, res) => {
  console.log("333", Date.now());
  res.send("<h1>333</h1>");
});

/* 
  next() æ˜¯å›è°ƒå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨å‡½æ•°åï¼Œå¯ä»¥è§¦å‘åç»­çš„ä¸­é—´é—´
  next() ä¸èƒ½åœ¨å“åº”å¤„ç†å®Œæ¯•åä½¿ç”¨
*/
app.use((req, res, next) => {
  console.log("111", Date.now());
  next(); // [!code ++]
});
app.use((req, res, next) => {
  console.log("222", Date.now());
  next(); // [!code ++]
});
app.use((req, res, next) => {
  console.log("333", Date.now());
  next(); // [!code ++]
});
```

### nodemon

`nodemon` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼ˆç›‘è§†å™¨ï¼‰ï¼Œç”¨æ¥ç›‘è§† node.js åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•æ›´æ”¹å¹¶è‡ªåŠ¨é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

1. å…¨å±€å®‰è£…

```shell
# å®‰è£…
$ npm install -g nodemon # npm å…¨å±€å®‰è£…
$ yarn global add nodemon # yarn å…¨å±€å®‰è£…

# å¯åŠ¨
$ nodemon # é»˜è®¤å¯åŠ¨ index.js
$ nodemon xxx.js # å¯åŠ¨æŒ‡å®šçš„ js
```

:::warning
é€šè¿‡ yarn è¿›è¡Œå…¨å±€å®‰è£…æ—¶ï¼Œé»˜è®¤ yarn çš„ç›®å½•å¹¶ä¸åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨å°†è·¯å¾„æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­

```shell
# æŸ¥è¯¢ yarn å…¨å±€å®‰è£…çš„è·¯å¾„
$ yarn global bin # ä¾‹ /Users/xxx/.yarn/bin
```

å°†ä¸Šè¿°æŸ¥è¯¢åˆ°çš„ `yarn å…¨å±€å®‰è£…çš„è·¯å¾„`æ·»åŠ åˆ°`ç³»ç»Ÿç¯å¢ƒå˜é‡ Path`ä¸­ï¼Œ`é‡å¯å¼€å‘å·¥å…·`å³å¯
:::

2. é¡¹ç›®å®‰è£…

```shell
# å¼€å‘ä¾èµ–
$ npm i -D nodemon # npm é¡¹ç›®å®‰è£…
$ yarn add -D nodemon # yarn é¡¹ç›®å®‰è£…

# npx æ‰§è¡Œ node æ¨¡å—
npx nodemon # å¯åŠ¨ index.js
npx nodemon xxx.js # å¯åŠ¨æŒ‡å®šçš„ js
```

```javascript
// package.json
{
  "scripts": {
    "start": "npx nodemon index.js" // ç®€åŒ–å¯åŠ¨å‘½ä»¤
  }
}
```

:::tip ç«¯å£çŸ¥è¯†
ç«¯å£å·ï¼Œä¸º 0 ~ 65535

ä¸€èˆ¬è‡ªå®šä¹‰çš„ï¼Œä¸ºå››ä½ç«¯å£å·
:::

### é™æ€èµ„æº

æœåŠ¡å™¨ä¸­çš„ä»£ç ï¼Œå¯¹äºå¤–éƒ¨æ¥è¯´éƒ½æ˜¯ä¸å¯è§çš„

æ‰€ä»¥æˆ‘ä»¬å†™çš„ html é¡µé¢ï¼Œ`æµè§ˆå™¨æ— æ³•ç›´æ¥è®¿é—®`

å¦‚æœå¸Œæœ›æµè§ˆå™¨å¯ä»¥è®¿é—®ï¼Œåˆ™éœ€è¦å°†é¡µé¢æ‰€åœ¨çš„ç›®å½•è®¾ç½®`é™æ€èµ„æº`çš„ç›®å½•

```javascript
const express = require("express");
const path = require("path");

const app = express();

// è®¾ç½® static ä¸­é—´é—´åï¼Œ  // [!code ++]
// æµè§ˆå™¨è®¿é—®æ—¶ï¼Œä¼šè‡ªåŠ¨å» public ç›®å½•å¯»æ‰¾æ˜¯å¦æœ‰åŒ¹é…çš„é™æ€èµ„æº  // [!code ++]
app.use(express.static(path.resolve(__dirname, "./public"))); // è®¾ç½®é™æ€èµ„æºçš„ä¸­é—´ä»¶ // [!code ++]

app.get("/hello", (req, res) => {
  res.send("Hello World");
});
app.listen(3000, () => {
  console.log("æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ");
});
```

```html
<!-- /public/index.html -->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>hello world</h1>
  </body>
</html>
```

è®¿é—®è·¯å¾„ `localhost:3000` æˆ– `localhost:3000/index.html`

:::details Demo ç”¨æˆ·ç™»å½• ï¼ˆGet è¯·æ±‚ï¼‰

```html
<!-- /public/login.html -->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <form action="/login" method="get">
      <p>
        <span>ç”¨æˆ·å</span>
        <input type="text" name="username" />
      </p>
      <p>
        <span>å¯†ç </span>
        <input type="password" name="password" />
      </p>
      <p>
        <input type="submit" value="ç™»å½•" />
      </p>
    </form>
  </body>
</html>
```

<br />

```javascript
/* /index.js */
const express = require("express");
const path = require("path");

const app = express();

app.use(express.static(path.join(__dirname, "public")));

app.get("/", (req, res) => {
  res.send("<h1>å¤§èªæ˜</h1>");
});

app.get("/login", (req, res) => {
  console.log("æ¥æ”¶åˆ°ç™»å½•è¯·æ±‚");
  const { username, password } = req.query;
  if (username === "admin" && password === "123456") {
    res.send("<h1>ç™»å½•æˆåŠŸ</h1>");
  } else {
    res.send("<h1>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</h1>");
  }
});

app.listen(3000, () => {
  console.log("Server is running on port 3000");
});
```

<br />

```json
/* package.json */
{
  "name": "node",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^4.21.2"
  }
}
```

:::

### param & post è¯·æ±‚

#### param

get è¯·æ±‚å‘é€ç»™å‚æ•°çš„ç¬¬äºŒç§æ–¹å¼

/hello/:id è¡¨ç¤ºå½“ç”¨æˆ·è®¿é—® /hello/xxx æ—¶å°±ä¼šè§¦å‘

/hello/:name/:age/:gender å¤šä¸ªå‚æ•°æ—¶è¡¨ç¤º

åœ¨è·¯å¾„ä¸­ä»¥å†’å·å‘½åçš„éƒ¨åˆ†æˆ‘ä»¬ç§°ä¸º param ï¼ˆè¯·æ±‚å‚æ•°ï¼‰ï¼Œåœ¨ get è¯·æ±‚æ—¶ï¼Œå®ƒå¯ä»¥è¢«æ¥æ”¶åˆ°

```javascript
app.get("/hello/:id", (req, res) => {
  // é€šè¿‡ req.params å±æ€§æ¥è·å–è¿™äº›å‚æ•°
  console.log(req.params);
});
```

:::warning
æœ¬è´¨ä¸Šä¸¤è€…æ²¡æœ‰åŒºåˆ«ï¼Œå‡æ˜¯é€šè¿‡è·¯å¾„çš„æ–¹å¼å»ä¼ é€’å‚æ•°ã€‚

query `æŸ¥è¯¢å­—ç¬¦ä¸²`ï¼ˆä»¥å¯¹è±¡çš„æ–¹å¼ä¼ å‚ï¼Œå‚æ•°å¯é€‰ï¼‰

param `è¯·æ±‚å‚æ•°`ï¼ˆä¸ç”¨æŒ‡å®šå±æ€§åï¼ŒæœåŠ¡ç«¯æ¥æ”¶æ‰æŒ‡å®šï¼Œå‚æ•°ä¸å¯é€‰ï¼‰
:::

#### post

åœ¨è¯·æ±‚ä½“ä¸­ï¼Œæ¥æ”¶å‚æ•° req.body

`é»˜è®¤æƒ…å†µä¸‹ express ä¸ä¼šè‡ªå®šè§£æè¯·æ±‚ä½“ï¼Œéœ€è¦é…ç½®ä¸­é—´ä»¶`

:::details Demo ç”¨æˆ·ç™»å½• ï¼ˆPost è¯·æ±‚ï¼‰

```html
<!-- /public/login.html -->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <form action="/login" method="post">
      <p>
        <span>ç”¨æˆ·å</span>
        <input type="text" name="username" />
      </p>
      <p>
        <span>å¯†ç </span>
        <input type="password" name="password" />
      </p>
      <p>
        <input type="submit" value="ç™»å½•" />
      </p>
    </form>
  </body>
</html>
```

<br />

```javascript
/* /index.js */
const express = require("express");
const path = require("path");

const app = express();

app.use(express.urlencoded({ extended: true })); // é…ç½®è§£æè¯·æ±‚ä½“çš„ä¸­é—´ä»¶ // [!code ++]

app.use(express.static(path.join(__dirname, "public")));

app.get("/", (req, res) => {
  res.send("<h1>å¤§èªæ˜</h1>");
});

app.get("/login", (req, res) => {
  console.log("æ¥æ”¶åˆ°ç™»å½•è¯·æ±‚");
  const { username, password } = req.query;
  if (username === "admin" && password === "123456") {
    res.send("<h1>ç™»å½•æˆåŠŸ</h1>");
  } else {
    res.send("<h1>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</h1>");
  }
});

app.post("/login", (req, res) => {
  console.log("æ¥æ”¶åˆ°ç™»å½•è¯·æ±‚ post");
  const { username, password } = req.body; // [!code ++]
  if (username === "admin" && password === "123456") {
    res.send("<h1>ç™»å½•æˆåŠŸ</h1>");
  } else {
    res.send("<h1>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</h1>");
  }
});

app.listen(3000, () => {
  console.log("Server is running on port 3000");
});
```

<br />

```json
/* package.json */
{
  "name": "node",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^4.21.2"
  }
}
```

:::

### æ¨¡æ¿å¼•æ“

:::tip å¤„ç†é”™è¯¯çš„è·¯ç”±

å¯ä»¥åœ¨æ‰€æœ‰è·¯ç”±çš„åè¾¹é…ç½®é”™è¯¯è·¯ç”±

åªè¦è¿™ä¸ªä¸­é—´ä»¶ä¸€æ‰§è¡Œï¼Œè¯´æ˜ä¸Šé¢çš„åœ°å€éƒ½æ²¡æœ‰åŒ¹é…

```javascript
const express = require("express");
const path = require("path");
const app = express();
app.use(express.urlencoded());
app.use(express.static(path.join(__dirname, "public")));

app.use((req, res) => {
  res.statue(404);
  res.send("<h1>æ‚¨è®¿é—®çš„åœ°å€å·²è¢«å¤–æ˜ŸäººåŠ«æŒï¼</h1>");
});

app.listen(3000, () => {
  console.log("Server is running on port 3000");
});
```

:::

html é¡µé¢å±äºé™æ€é¡µé¢ï¼Œåˆ›å»ºçš„æ—¶å€™ä»€ä¹ˆæ ·å­ï¼Œç”¨æˆ·çœ‹åˆ°å°±æ˜¯ä»€ä¹ˆæ ·å­ï¼Œä¸ä¼šè‡ªåŠ¨è·ŸéšæœåŠ¡å™¨ä¸­æ•°æ®çš„å˜åŒ–è€Œå˜åŒ–ã€‚

å¸Œæœ›æœ‰è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ï¼Œå®ƒé•¿å¾—åƒæ˜¯ç½‘é¡µï¼Œä½†å®ƒé‡Œè¾¹å¯ä»¥åµŒå…¥å˜é‡ï¼Œè¿™ä¸ªä¸œè¥¿åœ¨ node ä¸­è¢«ç§°ä¸º`æ¨¡æ¿`

åœ¨ node ä¸­æœ‰å¾ˆå¤šä¸ª`æ¨¡æ¿å¼•æ“`ï¼Œæ¨è `ejs`

:::tip

Which template engines does Express support?

Express æ”¯æŒå“ªäº›æ¨¡æ¿å¼•æ“ï¼Ÿ

Express supports any template engine that conforms with the (path, locals, callback) signature. To normalize template engine interfaces and caching, see the [consolidate.js](https://github.com/visionmedia/consolidate.js) project for support. Unlisted template engines might still support the Express signature.

Express æ”¯æŒä»»ä½•ç¬¦åˆ ï¼ˆpathï¼Œ localsï¼Œ callbackï¼‰ ç­¾åçš„æ¨¡æ¿å¼•æ“ã€‚ è¦è§„èŒƒåŒ–æ¨¡æ¿å¼•æ“æ¥å£å’Œç¼“å­˜ï¼Œè¯·å‚é˜… [consolidate.js](https://github.com/visionmedia/consolidate.js) é¡¹ç›®å¯»æ±‚æ”¯æŒã€‚æœªåˆ—å‡ºçš„æ¨¡æ¿å¼•æ“å¯èƒ½ä»æ”¯æŒ Express ç­¾åã€‚

For more information, see [Using template engines with Express](https://expressjs.com/en/guide/using-template-engines.html).

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[å°†æ¨¡æ¿å¼•æ“ä¸ Express ç»“åˆä½¿ç”¨](https://expressjs.com/en/guide/using-template-engines.html)ã€‚

<hr />

[æ­£åœ¨é˜…è¯» ğŸ‘‰](https://expressjs.com/en/starter/faq.html#which-template-engines-does-express-support)
:::

#### ä½¿ç”¨æ­¥éª¤

1. å®‰è£… ejsï¼›
2. é…ç½® express çš„æ¨¡æ¿å¼•æ“ä¸º ejsï¼›
3. é…ç½®æ¨¡æ¿è·¯å¾„ï¼›`æ³¨æ„ï¼Œæ¨¡æ¿å¼•æ“éœ€è¦è¢« express æ¸²æŸ“åæ‰èƒ½ä½¿ç”¨`

[EJS Github ğŸ‘‰](https://github.com/mde/ejs)

```shell
npm install ejs
```

```javascript
/* main.js */
const express = require("express");
const app = express();

// 1.
// å°† ejs è®¾ç½®ä¸ºé»˜è®¤çš„æ¨¡æ¿å¼•æ“ // [!code ++]
app.set("view engine", "ejs"); // [!code ++]

// 2.
// é…ç½®æ¨¡æ¿è·¯å¾„ã€é»˜è®¤ã€‘ // [!code ++]
// app.set("views", "views"); // [!code ++]
// é…ç½®æ¨¡æ¿è·¯å¾„ã€è‡ªå®šä¹‰ã€‘ // [!code ++]
app.set("views", path.resolve(__dirname, "views")); // [!code ++]

// 3. æ¸²æŸ“ // [!code ++]
app.get("/students", (req, res) => {
  // res.render() ç”¨æ¥æ¸²æŸ“ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œå¹¶å°†å…¶è¿”å›ç»™æµè§ˆå™¨ // [!code ++]
  res.render("students"); // [!code ++]
});

app.listen(3000, () => {
  console.log("Server is running on port 3000");
});
```

```ejs
<!-- /views/students.ejs -->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¿™æ˜¯ ejs æ¨¡æ¿</title>
  </head>
  <body>
    <h1>Hello EJS</h1>
  </body>
</html>
```

#### ä¼ é€’æ•°æ®

:::details ä¼ é€’æ•°æ®ï¼Œä¸”æ¸²æŸ“

```javascript
/* main.js */
const express = require("express");
const app = express();

app.set("view engine", "ejs");
app.set("views", path.resolve(__dirname, "views"));
app.get("/students", (req, res) => {
  res.render("students", { name: "å­™æ‚Ÿç©º", age: 18 }); // [!code ++]
});

app.listen(3000, () => {
  console.log("Server is running on port 3000");
});
```

<br />

```ejs
<!-- /views/students.ejs -->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¿™æ˜¯ ejs æ¨¡æ¿</title>
  </head>
  <body>
    <h1>Hello EJS</h1>
    <!-- æ¥æ”¶å‚æ•°ï¼Œä¸”æ¸²æŸ“ -->
    <h2><%=name %></h2>
    <h2><%=age %></h2>
  </body>
</html>
```

:::

:::warning
<%= %> è¯­æ³•ï¼Œåœ¨ ejs ä¸­è¾“å‡ºå†…å®¹æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å¯¹å­—ç¬¦ä¸²çš„ç‰¹æ®Šç¬¦å·è¿›è¡Œè½¬ä¹‰

`é˜²æ­¢ XSS æ”»å‡»`

```javascript
res.render("students", { hello: "<h1>å“ˆå“ˆå“ˆ</h1>" });
```

<br />

```ejs
<%# å°†ç›´æ¥æ¸²æŸ“ä¸ºå­—ç¬¦ä¸²ï¼Œä¸ä¼šè§£æä¸ºh1æ ‡ç­¾ %>
<%=hello %>

<%# åŸæ ·è¾“å‡ºï¼Œå³è§£æh1æ ‡ç­¾ %>
<%-hello %>
```

:::

æ³¨é‡Šè¯­æ³•

```ejs
<%#å•è¡Œæ³¨é‡Š  %>

<%
  // console.log('js è¯­æ³•æ³¨é‡Š')
%>
```

### ç»ƒä¹ 

å¢åˆ æŸ¥æ”¹ CRUD

å…¨ç§°å¢åŠ ï¼ˆCreateï¼Œæ„ä¸ºâ€œå»ºç«‹â€ï¼‰ã€åˆ é™¤ï¼ˆDeleteï¼‰ã€æŸ¥è¯¢ï¼ˆReadï¼Œæ„ä¸ºâ€œè¯»å–â€ï¼‰ã€æ”¹æ­£ï¼ˆUpdateï¼Œæ„ä¸ºâ€œæ›´æ–°â€ï¼‰

å®Œæ•´ç»ƒä¹ å†…å®¹è¯·è§‚çœ‹ ç¬¬äºŒåäº”å’Œç¬¬äºŒåå…­é›†è§†é¢‘ï¼Œ [Node.js å®Œå…¨æŒ‡å—ï¼ˆç›´æ’­å›æ”¾ï¼‰æç«‹è¶…](https://www.bilibili.com/video/BV1qN4y1A7jM/)

#### ä»£ç å°æŠ„

```javascript
res.redirect(); // è·¯ç”±é‡å®šå‘
```

```javascript
/* main.js */
// æ•°æ®æŒä¹…åŒ–ï¼Œå­˜ json æ–‡ä»¶

// è¯»
const STUDENT_ARR = require("./data/students.json");

// å†™
const path = require("path");
const fs = require("fs/promises");
fs.writeFile(path.resolve("__dirname", "./data/students.json"), JSON.stringify(STUDENT_ARR))
  .then((res) => {
    // å†™å…¥æˆåŠŸ
  })
  .catch((err) => {
    // å†™å…¥å¤±è´¥
  });
```

### Router

`Router` æ˜¯ express ä¸­åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡

router å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯ä»¥åœ¨è¯¥ä¸­é—´ä»¶ç»‘å®šå„ç§è·¯ç”±ä»¥åŠå…¶ä»–çš„ä¸­é—´ä»¶

`å¯ä»¥ç”¨æ¥ç»‘å®šè·¯ç”±çš„ä¸€ä¸ªå·¥å…·`

#### åˆ›å»º

```javascript
/* main.js */
const express = require("express");
const router = express.Router();
```

#### ç»‘å®š

```javascript
/* main.js */
const express = require("express");
const app = express();
const router = express.Router();

router.get("/Hello", (req, res) => {
  res.send("Hello World");
});

app.use(router);
```

#### æœ€ç»ˆä½¿ç”¨

`å®ç°è·¯ç”±çš„æ‹†åˆ†ï¼Œä»£ç è§£è€¦`

express() åªèƒ½å®ä¾‹ä¸€æ¬¡

```javascript
/* /routes/user.js */
const express = require("express");

// åˆ›å»ºè·¯ç”±
const router = express.Router();
router.get("/hello", (req, res) => {
  res.send("Hello World");
});

// æš´éœ²åˆ°æ¨¡å—å¤–
module.export = router;
```

```javascript{3}
/* main.js */
const express = require("express");
const app = express();
const userRouter = require("./routes/user.js");

app.use(userRouter);

app.license(3000, () => {
  console.log("æœåŠ¡å™¨å·²å¯åŠ¨ï¼");
});
```

#### è·¯ç”±é‡å¤è§£å†³

å½“è·¯ç”±è¿‡å¤šæ—¶ï¼Œå­˜åœ¨è·¯ç”±é‡å¤çš„æƒ…å†µï¼Œå¯ä»¥åœ¨ app.use() çš„æ—¶å€™æŒ‡å®š`å‰ç¼€/å‘½åç©ºé—´/å­è·¯ç”±`

```javascript{4}
/* /routes/user.js */
const express = require("express");
const router = express.Router();
router.get("/list", (req, res) => {
  res.send("list-user");
});
module.export = router;
```

```javascript{4}
/* /routes/goods.js */
const express = require("express");
const router = express.Router();
router.get("/list", (req, res) => {
  res.send("list-goods");
});
module.export = router;
```

```javascript
/* main.js */
const express = require("express");
const app = express();
const userRouter = require("./routes/user.js");
const goodsRouter = require("./routes/goods.js");

app.use(userRouter); // [!code --]
app.use(goodsRouter); // [!code --]
app.use("/user", userRouter); // [!code ++]
app.use("/goods", goodsRouter); // [!code ++]

app.license(3000, () => {
  console.log("æœåŠ¡å™¨å·²å¯åŠ¨ï¼");
});
```

### Cookie

#### ç®€ä»‹

HTTP åè®®æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„åè®®ï¼ŒæœåŠ¡å™¨æ— æ³•åŒºåˆ†è¯·æ±‚æ˜¯å¦å‘é€è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯ã€‚

cookie æ˜¯ Http åè®®ä¸­ç”¨æ¥è§£å†³æ— çŠ¶æ€é—®é¢˜çš„æŠ€æœ¯ã€‚

cookie çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå¤´

æœåŠ¡å™¨ä»¥å“åº”å¤´çš„å½¢å¼å°† cookie å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°ä»¥åä¼šå°†å…¶å­˜å‚¨ï¼Œå¹¶åœ¨ä¸‹æ¬¡å‘æœåŠ¡å™¨å‘é€å‘é€è¯·æ±‚æ—¶å°†å…¶ä¼ å›ï¼Œè¿™æ ·æœåŠ¡å™¨å°±å¯ä»¥æ ¹æ® cookie æ¥è¯†åˆ«å®¢æˆ·ç«¯äº†ã€‚

#### ä½¿ç”¨

##### 1. è®¾ç½® cookie

æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€ cookieï¼š

```javascript
/* main.js */
const express = require("express");
const app = express();

app.get("/set-cookie", (req, res) => {
  res.cookie("token", 123123); // [!code ++]
  res.send("è®¾ç½® cookie");
});
```

å½“è¯·æ±‚ `/set-cookie` åï¼Œå¯ä»¥åœ¨`æµè§ˆå™¨æ§åˆ¶é¢æ¿-ç½‘ç»œ-å“åº”æ ‡å¤´`ä¸­çœ‹åˆ°è®¾ç½®çš„ Set-Cookie å­—æ®µã€‚

##### 2. æ¥æ”¶ cookie

æœåŠ¡å™¨è¯»å–å®¢æˆ·ç«¯è¿”å›çš„ cookieï¼š

`éœ€è¦å®‰è£…ä¸­é—´ä»¶ cookie-parser æ’ä»¶`

```shell
npm install cookie-parser
```

```javascript
/* main.js */
const express = require("express");
const app = express();
const cookieParser = require("cookie-parser"); // [!code ++]

app.use(cookieParser()); // è®¾ç½® cookie è§£æä¸­é—´ä»¶ // [!code ++]
app.get("/get-cookie", (req, res) => {
  const token = req.cookies.token; // [!code ++]
  res.send("è·å– cookie");
});
```

å½“è¯·æ±‚ `/get-cookie` åï¼Œå¯ä»¥åœ¨`æµè§ˆå™¨æ§åˆ¶é¢æ¿-ç½‘ç»œ-è¯·æ±‚æ ‡å¤´`ä¸­çœ‹åˆ°è®¾ç½®çš„ Cookie å­—æ®µã€‚

##### 3. cookie æœ‰æ•ˆæœŸ

cookie æ˜¯æœ‰æœ‰æ•ˆæœŸçš„

é»˜è®¤æƒ…å†µä¸‹ï¼Œcookie çš„æœ‰æ•ˆæœŸå°±æ˜¯ä¸€æ¬¡ä¼šè¯ï¼ˆsessionï¼‰ï¼Œä¼šè¯æ˜¯ä¸€æ¬¡æ‰“å¼€åˆ°å…³é—­æµè§ˆå™¨çš„è¿‡ç¨‹ã€‚

###### 3.1 expires

æŒ‡å®šå…·ä½“è¿‡æœŸæ—¶é—´

```javascript
app.get("/set", (req, res) => {
  res.cookie("token", 123123, {
    expires: new Date(), // [!code ++]
  });
});
```

###### 3.2 maxAge

è®¾ç½®æœ‰æ•ˆæ—¶é—´ï¼Œå¤šä¹…åè¿‡æœŸï¼Œå•ä½ï¼šms

```javascript
app.get("/set", (req, res) => {
  res.cookie("token", 123123, {
    maxAge: 2000, // [!code ++]
  });
});
```

##### 4. åˆ é™¤ cookie

cookie ä¸€æ—¦å‘é€ç»™æµè§ˆå™¨ï¼Œæˆ‘ä»¬å°±ä¸èƒ½å†ä¿®æ”¹äº†

ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘é€`æ–°çš„åŒå`cookie æ¥æ›¿æ¢æ—§ cookieï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹çš„ç›®çš„

```javascript
app.get("/delete", (req, res) => {
  res.cookie("token", "", { maxAge: 0 }); // [!code ++]
  res.send("åˆ é™¤ cookie");
});
```

:::details CookieOptions é…ç½®å¯¹è±¡

```typescript
{
  cookie(name: string, val: any, options: CookieOptions): this;
}
```

<br />

```typescript
/**
 * Options passed down into `res.cookie`
 * @link https://expressjs.com/en/api.html#res.cookie
 */
export interface CookieOptions {
  /** Convenient option for setting the expiry time relative to the current time in **milliseconds**. */
  maxAge?: number | undefined;
  /** Indicates if the cookie should be signed. */
  signed?: boolean | undefined;
  /** Expiry date of the cookie in GMT. If not specified or set to 0, creates a session cookie. */
  expires?: Date | undefined;
  /** Flags the cookie to be accessible only by the web server. */
  httpOnly?: boolean | undefined;
  /** Path for the cookie. Defaults to â€œ/â€. */
  path?: string | undefined;
  /** Domain name for the cookie. Defaults to the domain name of the app. */
  domain?: string | undefined;
  /** Marks the cookie to be used with HTTPS only. */
  secure?: boolean | undefined;
  /** A synchronous function used for cookie value encoding. Defaults to encodeURIComponent. */
  encode?: ((val: string) => string) | undefined;
  /**
   * Value of the â€œSameSiteâ€ Set-Cookie attribute.
   * @link https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00#section-4.1.1.
   */
  sameSite?: boolean | "lax" | "strict" | "none" | undefined;
  /**
   * Value of the â€œPriorityâ€ Set-Cookie attribute.
   * @link https://datatracker.ietf.org/doc/html/draft-west-cookie-priority-00#section-4.3
   */
  priority?: "low" | "medium" | "high";
  /** Marks the cookie to use partioned storage. */
  partitioned?: boolean | undefined;
}
```

:::

### Session

cookie çš„ä¸è¶³ï¼š

cookie æ˜¯ç”±æœåŠ¡å™¨åˆ›å»ºï¼Œæµè§ˆå™¨ä¿å­˜ï¼Œ`æ¯æ¬¡`æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨æ—¶éƒ½éœ€è¦å°† cookie å‘å›ï¼Œå¯¼è‡´`ä¸èƒ½åœ¨ cookie ä¸­å­˜æ”¾è¾ƒå¤šçš„æ•°æ®`ï¼Œå¹¶ä¸” cookie æ˜¯ç›´æ¥å­˜å‚¨åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œ`å®¹æ˜“è¢«ç¯¡æ”¹ç›—ç”¨ï¼ˆæ˜æ–‡å­˜å‚¨ï¼‰`

æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ cookie ä¸€å®šä¸ä¼šåœ¨ cookie ä¸­æ˜¥åˆæ•æ„Ÿä¿¡æ¯

ä¸ºäº†è§£å†³ cookie çš„ä¸è¶³ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥å°†ç”¨æˆ·çš„æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸­ï¼Œæ¯ä¸€ä¸ªç”¨æˆ·çš„æ•°æ®éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ idï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ cookie å°† id å‘é€ç»™æµè§ˆå™¨,æµè§ˆå™¨åªéœ€æ¯æ¬¡è®¿é—®æ—¶å°† id å‘å›ï¼Œå³å¯è¯»å–åˆ°æœåŠ¡å™¨ä¸­å­˜å‚¨çš„æ•°æ®ã€‚

è¿™ä¸ªæŠ€æœ¯æˆ‘ä»¬ç§°ä¹‹ä¸º sessionï¼ˆä¼šè¯ï¼‰

#### ç®€ä»‹

`session æ˜¯æœåŠ¡å™¨ä¸­çš„ä¸€ä¸ªå¯¹è±¡`ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨æ¥å­˜å‚¨ç”¨æˆ·çš„æ•°æ®ï¼›

æ¯ä¸€ä¸ª session å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œsession åˆ›å»ºåï¼Œid ä¼šä»¥ cookie çš„å½¢å¼å‘é€ç»™å®¢æˆ·ç«¯ï¼›

å®¢æˆ·ç«¯æ”¶åˆ°ä»¥åï¼Œæ¯æ¬¡è®¿é—®/è¯·æ±‚éƒ½ä¼šå°† id å‘å›ï¼ŒæœåŠ¡å™¨ä¸­å°±å¯ä»¥æ ¹æ® id æ‰¾åˆ°å¯¹åº”çš„ session

ä¸»è¦çš„ä¸¤éƒ¨åˆ†ï¼š

1. æœåŠ¡å™¨ç«¯ï¼šå­˜å‚¨ session æ•°æ®çš„å¯¹è±¡
2. å®¢æˆ·ç«¯ï¼šå­˜å‚¨ session id çš„ cookie

ä»€ä¹ˆæ—¶å€™ä¼šå¤±æ•ˆï¼Ÿ

1. æœåŠ¡å™¨ä¸­çš„ session å¯¹è±¡æ²¡äº†
2. cookie è¿‡æœŸ

åœ¨ express ä¸­ï¼Œå¯ä»¥é€šè¿‡ express-session ç»„ä»¶æ¥å®ç° session åŠŸèƒ½ï¼Œexpress-session é»˜è®¤æ˜¯å°† session å­˜å‚¨åˆ°å†…å­˜ä¸­çš„ï¼Œæ‰€æœ‰æœåŠ¡å™¨ä¸€æ—¦é‡å¯ session ä¼šè‡ªåŠ¨é‡ç½®ã€‚æ‰€ä»¥`ä½¿ç”¨ session é€šå¸¸ä¼šå¯¹ session è¿›è¡ŒæŒä¹…åŒ–çš„æ“ä½œï¼ˆå†™åˆ°æ–‡ä»¶æˆ–æ•°æ®åº“ï¼‰` [ç«‹å³é˜…è¯»](#æŒä¹…åŒ–)

#### ä½¿ç”¨

1. å®‰è£…ç»„ä»¶

```shell
npm install express-session
```

2. é…ç½®ä¸­é—´ä»¶

```javascript{6,7,8,9,10}
/* main.js */
const express = require("express");
const app = express();
const expressSession = require("express-session");

app.use(
  expressSession({
    secret: "123123", // å¯†é’¥
  })
);
```

:::details SessionOptions é…ç½®å¯¹è±¡

```typescript
declare function session(options?: session.SessionOptions): express.RequestHandler;

declare namespace session {
  interface SessionOptions {
    /**
     * This is the secret used to sign the session ID cookie.
     * The secret can be any type of value that is supported by Node.js `crypto.createHmac` (like a string or a Buffer).
     * This can be either a single secret, or an array of multiple secrets.
     * If an array of secrets is provided, only the first element will be used to sign the session ID cookie, while all the elements will be considered when verifying the signature in requests.
     * The secret itself should be not easily parsed by a human and would best be a random set of characters.
     *
     * A best practice may include:
     * * The use of environment variables to store the secret, ensuring the secret itself does not exist in your repository.
     * * Periodic updates of the secret, while ensuring the previous secret is in the array.
     *
     * Using a secret that cannot be guessed will reduce the ability to hijack a session to only guessing the session ID (as determined by the `genid` option).
     *
     * Changing the secret value will invalidate all existing sessions.
     * In order to rotate the secret without invalidating sessions, provide an array of secrets, with the new secret as first element of the array, and including previous secrets as the later elements.
     *
     * Note HMAC-256 is used to sign the session ID. For this reason, the secret should contain at least 32 bytes of entropy.
     */
    secret: CipherKey | CipherKey[];

    /**
     * Function to call to generate a new session ID. Provide a function that returns a string that will be used as a session ID.
     * The function is given the request as the first argument if you want to use some value attached to it when generating the ID.
     *
     * The default value is a function which uses the uid-safe library to generate IDs.
     * Be careful to generate unique IDs so your sessions do not conflict.
     */
    genid?(req: express.Request): string;

    /**
     * The name of the session ID cookie to set in the response (and read from in the request).
     * The default value is 'connect.sid'.
     *
     * Note if you have multiple apps running on the same hostname (this is just the name, i.e. `localhost` or `127.0.0.1`; different schemes and ports do not name a different hostname),
     *   then you need to separate the session cookies from each other.
     * The simplest method is to simply set different names per app.
     */
    name?: string | undefined;

    /**
     * The session store instance, defaults to a new `MemoryStore` instance.
     * @see MemoryStore
     */
    store?: Store | undefined;

    /**
     * Settings object for the session ID cookie.
     * @see CookieOptions
     */
    cookie?: CookieOptions | undefined;

    /**
     * Force the session identifier cookie to be set on every response. The expiration is reset to the original `maxAge`, resetting the expiration countdown.
     * The default value is `false`.
     *
     * With this enabled, the session identifier cookie will expire in `maxAge` *since the last response was sent* instead of in `maxAge` *since the session was last modified by the server*.
     * This is typically used in conjuction with short, non-session-length `maxAge` values to provide a quick timeout of the session data
     *   with reduced potential of it occurring during on going server interactions.
     *
     * Note that when this option is set to `true` but the `saveUninitialized` option is set to `false`, the cookie will not be set on a response with an uninitialized session.
     * This option only modifies the behavior when an existing session was loaded for the request.
     *
     * @see saveUninitialized
     */
    rolling?: boolean | undefined;

    /**
     * Forces the session to be saved back to the session store, even if the session was never modified during the request.
     * Depending on your store this may be necessary, but it can also create race conditions where a client makes two parallel requests to your server
     *   and changes made to the session in one request may get overwritten when the other request ends, even if it made no changes (this behavior also depends on what store you're using).
     *
     * The default value is `true`, but using the default has been deprecated, as the default will change in the future.
     * Please research into this setting and choose what is appropriate to your use-case. Typically, you'll want `false`.
     *
     * How do I know if this is necessary for my store? The best way to know is to check with your store if it implements the `touch` method.
     * If it does, then you can safely set `resave: false`.
     * If it does not implement the `touch` method and your store sets an expiration date on stored sessions, then you likely need `resave: true`.
     */
    resave?: boolean | undefined;

    /**
     * Trust the reverse proxy when setting secure cookies (via the "X-Forwarded-Proto" header).
     * The default value is undefined.
     *
     * - `true`: The `X-Forwarded-Proto` header will be used.
     * - `false`: All headers are ignored and the connection is considered secure only if there is a direct TLS/SSL connection.
     * - `undefined`: Uses the "trust proxy" setting from express
     */
    proxy?: boolean | undefined;

    /**
     * Forces a session that is "uninitialized" to be saved to the store. A session is uninitialized when it is new but not modified.
     * Choosing `false` is useful for implementing login sessions, reducing server storage usage, or complying with laws that require permission before setting a cookie.
     * Choosing `false` will also help with race conditions where a client makes multiple parallel requests without a session.
     *
     * The default value is `true`, but using the default has been deprecated, as the default will change in the future.
     * Please research into this setting and choose what is appropriate to your use-case.
     *
     * **If you are using `express-session` in conjunction with PassportJS:**
     * Passport will add an empty Passport object to the session for use after a user is authenticated, which will be treated as a modification to the session, causing it to be saved.
     * This has been fixed in PassportJS 0.3.0.
     */
    saveUninitialized?: boolean | undefined;

    /**
     * Control the result of unsetting req.session (through delete, setting to null, etc.).
     * - `destroy`: The session will be destroyed (deleted) when the response ends.
     * - `keep`: The session in the store will be kept, but modifications made during the request are ignored and not saved.
     * @default 'keep'
     */
    unset?: "destroy" | "keep" | undefined;
  }
}
```

:::

3. è®¾ç½® & è·å– session

```javascript{12,13,14,15,17,18,19,20,21}
/* main.js */
const express = require("express");
const app = express();
const expressSession = require("express-session");

app.use(
  expressSession({
    secret: "123123", // å¯†é’¥
  })
);

app.get("/set", (req, res) => {
  req.session.username = "sunwukong";
  res.send("è®¾ç½® session");
});

app.get("/get", (req, res) => {
  const username = req.session.username;
  console.log(username);
  res.send("è·å– session");
});

app.listen(3000, () => {
  console.log("Server is running on port 3000");
});
```

4. ç»Ÿä¸€éªŒè¯

```javascript{9,10,11,12,13,14,15}
/* /routes/goods.js */
const express = require("express");
const router = express.Router();

/*
  å½“ goods ä¸­çš„è·¯ç”±å‡éœ€è¦éªŒè¯ session æ—¶
  å¯ä»¥é€šè¿‡è®¾ç½®ä¸­é—´ä»¶è¿›è¡Œæ‹¦æˆªï¼Œå¦‚éªŒè¯é€šè¿‡å°± next() æ”¾è¡Œ
*/
router.use((req, res) => {
  if (req.session.username) {
    next();
  } else {
    res.redirect("/");
  }
});

router.get("/list", (req, res) => {
  //
});
router.get("/add", (req, res) => {
  //
});
router.get("/delete", (req, res) => {
  //
});

module.export = router;
```

#### æŒä¹…åŒ–

[Compatible Session Stores - æŒä¹…åŒ–æ–¹æ¡ˆ](https://www.npmjs.com/package/express-session#compatible-session-stores)

[session-file-store](https://www.npmjs.com/package/session-file-store)

å°†æ¼”ç¤º`å­˜å‚¨æ–‡ä»¶`çš„æ–¹å¼ã€‚

â‘  å®‰è£… session-file-store
â‘¡ å¼•å…¥
â‘¢ è®¾ç½®ä¸ºä¸­é—´ä»¶

```shell
$ å®‰è£… session-file-store
npm install session-file-store
```

```javascript
const express = require("express");
const path = require("path");
const expressSession = require("express-session"); // å¼•å…¥ express-session
const FileStore = require("session-file-store")(expressSession); // å¼•å…¥ session-file-store

app.use(
  expressSession({
    store: new FileStore({
      // é…ç½®å¯¹è±¡
      // https://www.npmjs.com/package/session-file-store#Options

      /*
        æŒ‡å®š session æœ¬åœ°æ–‡ä»¶çš„è·¯å¾„
      */
      path: path.resolve(__dirname, "./sessions"),

      /* 
        åŠ å¯†å¯†é’¥
      */
      secret: "123123",

      /* 
        è¿‡æœŸæ—¶é—´ï¼Œæœ€å¤§é—²ç½®æ—¶é—´
        é»˜è®¤ 3600ï¼ˆ1å°æ—¶ï¼‰ï¼Œå•ä½ï¼šç§’
      */
      ttl: 3600,

      /* 
        æŒ‡å®šæ¸…é™¤ session çš„é—´éš”
        é»˜è®¤ 3600ï¼ˆ1å°æ—¶ï¼‰ï¼Œå•ä½ï¼šç§’
      */
      reapInterval: 3600,
    }),
    secret: "123123",
  })
);
```

### CSRF

`è·¨ç«™è¯·æ±‚ä¼ªé€ `ï¼ˆCSRFï¼‰æ˜¯ä¸€ç§å†’å……å—ä¿¡ä»»ç”¨æˆ·ï¼Œå‘æœåŠ¡å™¨å‘é€éé¢„æœŸè¯·æ±‚çš„æ”»å‡»æ–¹å¼ã€‚

[MDN - CSRF](https://developer.mozilla.org/zh-CN/docs/Glossary/CSRF)

#### csrf æ”»å‡»æ¼”ç¤º

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!-- å›¾åƒ -->
    <img src="http://loaclhost:3000/students/delete?id=3" />

    <!-- è¡¨å• -->
    <form action="http://localhost:3000/students/add" method="get">
      <input type="text" name="username" value="dazhaxie" />
      <input type="text" name="age" value="77" />
      <input type="text" name="gender" value="å¥³" />
      <input type="text" name="address" value="å®æ³¢" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

#### é˜²å¾¡ csrf æ”»å‡»

1. ä½¿ç”¨ referer å¤´æ¥æ£€æŸ¥è¯·æ±‚æ¥æº

```javascript
router.use((req, res, next) => {
  const referer = req.get("referer");
  // console.log("è¯·æ±‚æ¥è‡ªï¼š", referer);
  if (!referer || !referer.startsWith("http://localhost:3000/")) {
    res.status(403).send("ä½ æ²¡æœ‰è¿™ä¸ªæƒé™ï¼");
    return;
  }
});
```

2. ä½¿ç”¨éªŒè¯ç 
3. å°½é‡ä½¿ç”¨ post è¯·æ±‚ï¼ˆç»“åˆ tokenï¼‰

:::tip

tokenï¼ˆä»¤ç‰Œï¼‰

å¯ä»¥åœ¨åˆ›å»ºè¡¨å•æ—¶éšæœºç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Œç„¶åå°†ä»¤ç‰Œå­˜å‚¨åˆ° session ä¸­ï¼Œå¹¶é€šè¿‡æ¨¡æ¿å‘é€ç»™ç”¨æˆ·ï¼Œç”¨æˆ·æäº¤ä¿å•æ—¶ï¼Œå¿…é¡»å°† token å‘å›ï¼Œæ‰å¯ä»¥è¿›è¡Œåç»­æ“ä½œã€‚ï¼ˆå¯ä»¥ä½¿ç”¨ uuid æ¥ç”Ÿæˆ tokenï¼‰

:::
