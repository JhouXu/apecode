---
layout: doc
---

# Node å­¦ä¹ ç¬”è®°

## ç®€ä»‹

- è¿è¡Œåœ¨æœåŠ¡å™¨ç«¯çš„ JS
- ç”¨æ¥ç¼–å†™æœåŠ¡å™¨
- ç‰¹ç‚¹
  - å•çº¿ç¨‹ã€å¼‚æ­¥ã€éé˜»å¡
  - ç»Ÿä¸€ API

::: tip
ç‰ˆæœ¬ç®¡ç†å™¨ä¸»è¦æœ‰ nvm å’Œ nvsï¼Œé€šè¿‡ç®¡ç†å™¨å¯è‡ªç”±åˆ‡æ¢ä¸åŒçš„ node.js ç‰ˆæœ¬ï¼Œä»¥ä¾¿å¼€å‘ä¸åŒçš„é¡¹ç›®ã€‚

- [nvm](https://github.com/nvm-sh/nvm): ä¸€ä¸ª Node.js ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œä½¿ç”¨ bash å®ç°ï¼Œå‡ ä¹æ˜¯ä¸šå†…æœ€æœ‰åã€‚
- [nvs](https://github.com/jasongin/nvs): åŒæ ·æ˜¯ä¸€ä¸ªçš„ Node.js ç‰ˆæœ¬åˆ‡æ¢å™¨ï¼Œä½¿ç”¨ JavaScript å®ç°ï¼Œè·¨å¹³å°ã€‚

:::

JavaScript å’Œ Node.js çš„åŒºåˆ«ï¼š

|      åˆ†ç±»      | JavScript | Node.js |
| :------------: | :-------: | :-----: |
|   ECMAScript   |    âœ…     |   âœ…    |
| DOM - å®¿ä¸»å¯¹è±¡ |    âœ…     |   âŒ    |
| BOM - å®¿ä¸»å¯¹è±¡ |    âœ…     |   âŒ    |

> Node.js è™½ç„¶ä¹Ÿå±äº jsï¼Œä½†æ˜¯å®ƒå’Œæµè§ˆå™¨ä¸­ js è¿˜æ˜¯æœ‰æ‰€åŒºåˆ«çš„ã€‚å¯¹äº ECMAScript æ ‡å‡†æ¥è¯´ï¼Œå®ƒä»¬æ˜¯ä¸€è‡´çš„æ‰€ä»¥åƒæ˜¯åŸå§‹å€¼ã€æµç¨‹æ§åˆ¶è¯­å¥ã€è¿ç®—ç¬¦ã€å‡½æ•°ã€å¯¹è±¡ã€æ•°ç»„ã€å†…å»ºå¯¹è±¡è¿™äº›ä¸œè¥¿æ— è®ºæ˜¯æµè§ˆå™¨ç¯å¢ƒè¿˜æ˜¯ node ä¸­éƒ½æ˜¯ä¸€æ ·çš„ã€‚å¯¹äºå®¿ä¸»å¯¹è±¡æ¥è¯´æµè§ˆå™¨å’Œ node æ˜¯æˆªç„¶ä¸åŒçš„ï¼Œåƒæ˜¯ DOMã€BOM è¿™äº›å¯¹è±¡åœ¨ node ä¸­é€šé€šæ˜¯ä¸å­˜åœ¨çš„ï¼Œä½†æ˜¯ä¸€äº›ä¸œè¥¿åœ¨ Node ä¸­ä¾ç„¶å¾—åˆ°äº†ä¿ç•™ï¼Œæ¯”å¦‚ console å¯¹è±¡ã€æ¯”å¦‚å®šæ—¶å™¨ä¹‹ç±»ã€‚

## å¼‚æ­¥ç¼–ç¨‹ & Promise

::: tip
è¿›ç¨‹å’Œçº¿ç¨‹

- è¿›ç¨‹ï¼šç¨‹åºçš„è¿è¡Œç¯å¢ƒ
- çº¿ç¨‹ï¼šå®é™…è¿›è¡Œè¿ç®—çš„ä¸œè¥¿

:::

### åŒæ­¥å¼‚æ­¥

1. åŒæ­¥ï¼š

- é€šå¸¸æƒ…å†µä¸‹ä»£ç éƒ½æ˜¯`è‡ªä¸Šå‘ä¸‹ä¸€è¡Œä¸€è¡Œ`åœ°æ‰§è¡Œï¼Œå‰é¢çš„ä»£ç ä¸æ‰§è¡Œåé¢çš„ä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œ
- åŒæ­¥çš„ä»£ç æ‰§è¡Œä¼šå‡ºç°`é˜»å¡`çš„æƒ…å†µï¼Œä¸€è¡Œä»£ç æ‰§è¡Œæ…¢ä¼šå½±å“æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œ

2. è§£å†³åŒæ­¥é—®é¢˜ï¼š

- Java Python
  - é€šè¿‡å¤šçº¿ç¨‹æ¥è§£å†³
- Node.js
  - JS æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œé€šè¿‡`å¼‚æ­¥ç¼–ç¨‹`æ¥è§£å†³

3. å¼‚æ­¥ï¼š

- ä¸€æ®µä»£ç çš„æ‰§è¡Œä¸ä¼šå½±å“å…¶ä»–ç¨‹åºçš„æ‰§è¡Œ
- å¼‚æ­¥çš„é—®é¢˜ï¼š
  - `å¼‚æ­¥çš„ä»£ç æ— æ³•é€šè¿‡ return æ¥è®¾ç½®è¿”å›å€¼`

4. ç‰¹ç‚¹ï¼š

- 1. ä¸ä¼šé˜»å¡å…¶å®ƒä»£ç çš„æ‰§è¡Œ
- 2. éœ€è¦é€šè¿‡å›è°ƒå‡½æ•°æ¥è¿”å›ç»“æœ

5. å¼‚æ­¥å®ç°æ–¹å¼ï¼š

- å›è°ƒå‡½æ•°ï¼šè¿‡åº¦ä½¿ç”¨ä¼šå‡ºç°`å›è°ƒåœ°ç‹±`ï¼Œä»£ç çš„å¯è¯»æ€§å·®ã€å¯è°ƒè¯•æ€§å·®
- Promiseï¼š`æ˜¯å­˜å‚¨æ•°æ®çš„å¯¹è±¡`

```javascript
// å›è°ƒåœ°ç‹±æ¡ˆä¾‹
const sum = (a, b, cb) => {
  setTimeout(() => {
    cb(a + b);
  }, 1000);
};

sum(1, 2, (result) => {
  sum(result, 3, (result) => {
    sum(result, 4, (result) => {
      sum(result, 5, (result) => {
        console.log(result);
      });
    });
  });
});
```

### Promise

Promise å°±æ˜¯ä¸€ä¸ªç”¨æ¥`å­˜å‚¨æ•°æ®å¯¹è±¡`ï¼Œä½†æ˜¯ç”±äº Promise å­˜å–çš„æ–¹å¼çš„ç‰¹æ®Šï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†å¼‚æ­¥è°ƒç”¨çš„ç»“æœå­˜å‚¨åˆ° Promise ä¸­ã€‚

å¯¹ Promise è¿›è¡Œé“¾å¼è°ƒç”¨æ—¶ï¼š

- åè¾¹çš„æ–¹æ³•ï¼ˆthen å’Œ catchï¼‰è¯»å–çš„ä¸Šä¸€æ­¥çš„æ‰§è¡Œç»“æœï¼Œå¦‚æœä¸Šä¸€æ­¥çš„æ‰§è¡Œç»“æœä¸æ˜¯å½“å‰æƒ³è¦çš„ç»“æœï¼Œåˆ™è·³è¿‡å½“å‰çš„æ–¹æ³•ï¼›
- å½“ Promise å‡ºç°å¼‚å¸¸æ—¶ï¼Œè€Œæ•´ä¸ªè°ƒç”¨é“¾ä¸­æ²¡æœ‰å‡ºç° catchï¼Œåˆ™å¼‚å¸¸ä¼šå‘å¤–æŠ›å‡ºã€‚

`Promise è§£å†³å¼‚æ­¥ç¼–ç¨‹ä¸­å›è°ƒåœ°ç‹±é—®é¢˜`

#### æ¡ˆä¾‹

åˆ›å»º Promise å®ä¾‹ï¼ŒåŠè·å– Promise ä¸­çš„æ•°æ®

```javascript
// åˆ›å»º Promise æ—¶ï¼Œæ„é€ å‡½æ•°ä¸­éœ€è¦ä¸€ä¸ªå‡½æ•°[æ‰§è¡Œå™¨]ä½œä¸ºå‚æ•°
// Promise æ„é€ å‡½æ•°çš„å›è°ƒå‡½æ•°ï¼Œå®ƒä¼šåœ¨åˆ›å»º Promise æ—¶è°ƒç”¨ï¼Œè°ƒç”¨æ—¶ä¼šæœ‰ä¸¤ä¸ªå‚æ•°ä¼ é€’è¿›å»
const promise = new Promise((resolve, reject) => {
  // resolve å’Œ reject æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥åˆ†åˆ«å‘ Promise ä¸­å­˜å‚¨æ•°æ®
  // resolve è¡¨ç¤ºæ‰§è¡Œæ­£å¸¸æ—¶å­˜å‚¨æ•°æ®ï¼Œreject è¡¨ç¤ºæ‰§è¡Œå¼‚å¸¸æ—¶å­˜å‚¨æ•°æ®
  // é€šè¿‡å‡½æ•°æ¥å‘ Promise ä¸­æ·»åŠ æ•°æ®ï¼Œå¥½å¤„å°±æ˜¯å¯ä»¥æ·»åŠ å¼‚æ­¥è°ƒç”¨çš„æ•°æ®
  resolve("æˆåŠŸ"); // reject("å¤±è´¥")
});

// è·å– Promise ä¸­çš„æ•°æ®
//  - å¯ä»¥é€šè¿‡ Promise çš„å®ä¾‹æ–¹æ³• then æ¥è¯»å– Promise çš„æ•°æ®
//  - then éœ€è¦ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå›è°ƒå‡½æ•°ç”¨æ¥è·å– Promise ä¸­çš„æ•°æ®
//    - é€šè¿‡ resolve å­˜å‚¨çš„æ•°æ®ï¼Œä¼šè°ƒç”¨ç¬¬ä¸€ä¸ªå‡½æ•°è¿”å›ï¼Œ
//      å¯ä»¥åœ¨ç¬¬ä¸€ä¸ªå‡½æ•°ä¸­ç¼–å†™å¤„ç†æ•°æ®çš„ä»£ç 
//    - é€šè¿‡ reject å­˜å‚¨çš„æ•°æ®æˆ–å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šè°ƒç”¨ç¬¬äºŒä¸ªå‡½æ•°è¿”å›ï¼Œ
//      å¯ä»¥åœ¨ç¬¬äºŒä¸ªå‡½æ•°ä¸­ç¼–å†™å¤„ç†å¼‚å¸¸çš„ä»£ç 
promise.then(
  (result) => {
    console.log("resolve çš„æ•°æ®" + result);
  },
  (reason) => {
    console.log("reject çš„æ•°æ®" + reason);
  }
);

// or
promise
  .then((result) => {
    console.log("resolve çš„æ•°æ®" + result);
  })
  .catch((reason) => {
    console.log("reject çš„æ•°æ®" + reason);
  })
  .finally(() => {
    console.log("æ— è®º resolve è¿˜æ˜¯ reject éƒ½ä¼šæ‰§è¡Œ");
  });
```

å›è°ƒåœ°ç‹±çš„è§£å†³

```javascript
const sum = (a, b) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(a + b);
    }, 1000);
  });
};

sum(10, 20)
  .then((result) => {
    return sum(result, 30);
  })
  .then((result) => {
    return sum(result, 40);
  })
  .then((result) => {
    return sum(result, 50);
  })
  .then((result) => {
    console.log(result);
  });
```

#### å±æ€§

åœ¨ Promise ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªéšè—çš„å±æ€§

- [[PromiseResult]]ï¼Œç”¨æ¥å­˜å‚¨æ•°æ®
- [[PromiseState]]ï¼Œè®°å½• Promise çŠ¶æ€ï¼Œåªèƒ½ä¿®æ”¹ä¸€æ¬¡
  - `pending è¿›è¡Œä¸­`
  - `fulfilled å®Œæˆ`ï¼Œé€šè¿‡ resolve å­˜å‚¨æ•°æ®æ—¶
  - `rejected æ‹’ç»ã€å¼‚å¸¸`ï¼Œå½“å‡ºç°å¼‚å¸¸æˆ–é€šè¿‡ reject å­˜å‚¨æ•°æ®æ—¶

::: tip
åœ¨ Promise ä¸­è°ƒç”¨ thenã€catchã€finally æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ª`æ–°çš„ Promise`ï¼Œåœ¨ thenã€catch ä¸­ `æ–°çš„ Promise` ä¼šå­˜å‚¨`å›è°ƒå‡½æ•°çš„è¿”å›å€¼`ï¼Œfinally ä¸­ `æ–°çš„ Promise`å­˜å‚¨ä¸Šçš„å€¼`å§‹ç»ˆä¸º undefined`.

```javascript
let promise = new Promise((resolve, reject) => {
  resolve("åˆ›å»º Promise å®ä¾‹");
});

// promise é“¾å¼è°ƒç”¨
promise
  .then((result) => {
    console.log(result); // -> åˆ›å»º Promise å®ä¾‹ // [!code ++]
    return "promise å®ä¾‹è°ƒç”¨ then æ–¹æ³•";
  })
  .then((result) => {
    console.log(result); // -> promise å®ä¾‹è°ƒç”¨ then æ–¹æ³• // [!code ++]
  });
```

:::

#### é™æ€æ–¹æ³•

- Promise.resolve()
  - åˆ›å»ºä¸€ä¸ªç«‹å³å®Œæˆçš„ Promise
- Promise.reject()
  - åˆ›å»ºä¸€ä¸ªç«‹å³æ‹’ç»çš„ Promise
- Promise.all([iterable])
  - åŒæ—¶è¿”å›å¤šä¸ª Promise çš„æ‰§è¡Œç»“æœï¼Œå¦‚æœ‰ä¸€ä¸ª rejected å°±è¿”å›é”™è¯¯
- Promise.allSettled([iterable])
  - åŒæ—¶è¿”å›å¤šä¸ª Promise çš„æ‰§è¡Œç»“æœï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ fulfilled and rejected
- Promise.race([iterable])
  - è¿”å›æ‰§è¡Œæœ€å¿«çš„ Promiseï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ fulfilled and rejected
- Promise.any([iterable])
  - è¿”å›æ‰§è¡Œæœ€å¿«å®Œæˆ fulfilled çš„ Promiseï¼Œ

## å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

åœ¨ js ä¸­ï¼Œå®ƒæ˜¯å•çº¿ç¨‹çš„ï¼Œå®ƒçš„è¿è¡Œæ—¶åŸºäº`äº‹ä»¶å¾ªç¯æœºåˆ¶(event loop)`

å‰ç½®çŸ¥è¯†ï¼š

- æ ˆï¼Œä¸€ç§æ•°æ®ç»“æ„ï¼Œå…ˆè¿›åå‡º
- é˜Ÿåˆ—ï¼Œä¸€ç§æ•°æ®ç»“æ„ï¼Œå…ˆè¿›å…ˆå‡º

äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼š

- è°ƒç”¨æ ˆï¼Œå­˜æ”¾çš„æ˜¯éœ€è¦æ‰§è¡Œçš„ä»£ç 
- ä»»åŠ¡é˜Ÿåˆ—ï¼Œå­˜æ”¾çš„æ˜¯å°†è¦æ‰§è¡Œçš„ä»£ç 
  - å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ½ä¼šåˆ°æ­¤è¿›è¡Œæ’é˜Ÿ
  - å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ŒPromise çš„å›è°ƒå‡½æ•°

äº‹ä»¶å¾ªç¯æµç¨‹ï¼š

1. æ‰§è¡Œè°ƒç”¨æ ˆä¸­çš„ä»£ç 
2. æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç 
3. æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç 

::: info å°è¯•ç‰›åˆ€

```javascript
console.log(1);
setTimeout(() => console.log(2));
Promise.resolve().then(() => console.log(3));
Promise.resolve().then(() => setTimeout(() => console.log(4)));
Promise.resolve().then(() => console.log(5));
setTimeout(() => console.log(6));
console.log(7);
```

:::

::: details ç­”æ¡ˆ

```javascript
// 1 7 3 5 2 6 4
```

:::

::: tip
queueMicrotask() å¯ç”¨æ¥å‘å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡
:::

## æ‰‹å†™ Promise

## å‚è€ƒ

[Node.js å®Œå…¨æŒ‡å—ï¼ˆç›´æ’­å›æ”¾ï¼‰æç«‹è¶… - bilibili ğŸ“º](https://www.bilibili.com/video/BV1qN4y1A7jM)
